---
title: "[61일차] Backup & Recovery6"
excerpt: "아이티윌 0721"
categories:
      - ORACLE11g
tags:
      - ORACLE11g
      - TIL
last-modified-at: 2025-07-21T18:26
---

## archive mode

📍 로그 스위치 발생 시

1️⃣ 체크 포인트 발생

2️⃣ 리두 로그 파일을 저장 (ARC 라는 백그라운 프로세서가 처음 ~ 변경된 이력 모두 기록한다.)

아카이브 모드라도, 리두 로그가 하나라도 손실되면 불완전한 복구 방식(가장 최근에 백업받아 놓은 whole data file 리스트화) 으로 복구해야 한다.

매일 리두 체크해야하고, 리두가 손실되면 그 즉시 백업 받아야 한다.

- **NOARCHIVELOG vs ARCHIVELOG**
    
    📍**NOARCHIVELOG**
    
    - 기본적으로 데이터베이스는 NOARCHIVELOG 모드로 생성된다.
    - 데이터베이스를 정상적으로 종료 후에 백업을 받는다.
        - shutdown normal | transactional | immediate
    - 백업 대상 파일은 data file, control file은 필수로 백업을 받아야 하고 redo log file은 선택 사항이다.
    - NOARCHIVELOG모드의 복구는 리두에 손실로 인해 백업 시점으로 복구 작업을 할 수 밖에 없어서 데이터 손실이 발생할 수 있다.
    
    **NOARCHIVELOG 모드로 작동되는 데이터베이스의 특징** 
    
    - redo log 가 겹쳐 쓰여지면 마지막 백업에 대해서만 복구 작업을 할 수 있다.
    - redo log file 이 순환 방식으로 사용하기 때문에 백업 이후에 리두 정보가 없어질 수 있다.
    - redo log file 이 log switch 가 발생하면 checkpoint가 발생한 후 즉시 redo log file을 재사용할 수 있다.
    
    📍**ARCHIVELOG** 
    
    - log switch가 발생하면 checkpoint가 발생하고 arc 백그라운드 프로세스가 현재 redo log file을 물리적인 위치에 복사한 후 redo log file 은 재사용할 수 있다.
    - control file에 archive된 redo log file 정보를 기록된다.
    - 데이터베이스를 정상적인 종료 후에 백업을 수행할 수 있고 운영 중에 백업(일관성 없는 백업)을 수행할 수 있다.
    - 복구는 현재 문제되는 지점까지 복구가 가능하다. (리두가 있기 때문에)
    
- 모드 확인
    
    ```sql
    SYS@ora19c> archive log list
    
    Database log mode              No Archive Mode
    Automatic archival             Disabled
    Archive destination            USE_DB_RECOVERY_FILE_DEST
    Oldest online log sequence     9
    Current log sequence           11
    
    SYS@ora19c> show parameter db_recovery_file_dest 
    
    NAME                                 TYPE        VALUE
    ------------------------------------ ----------- ------------------------------
    db_recovery_file_dest                string      /u01/app/oracle/fast_recovery_
    db_recovery_file_dest_size           big integer 8256M
    ```
    
- Fast Recovery Area
    
    **오라클 디스크 백업 전략의 핵심 구성 요소**
    
    1️⃣ ASM(Automatic Storage Management, 자동 저장 영역 관리) 디스크 그룹 : 
    
    오라클 데이터베이스에 필요한 모든 recovery 관련 파일과 작업을 구성
    
    2️⃣ FRA(Fast Recovery Area) : 파일 시스템의 저장 영역 위치
    
    🌳 **영구 항목 : instance 에서 주로 사용**
    
    - 현재 control file의 다중화된 복사본
    - 온라인 리두 로그의 다중화된 복사본
    
    🌳 **임시 항목 : recovery 작업에서만 필요** 
    
    - 아카이브된 리두 로그
    - 데이터 파일 복사본 (RMAN 을 이용해서 backup as copy 명령을 수행하는 경우, 이미지 데이터 파일 복사본 생성)
    - control file 복사본
    - 백업 피스 (rman을 이용해서 백업)
    - Flashback log 정보 (flashback database가 활성화된 경우)
    
    Fast Recovery Area 구성
    
    ```sql
    SYS@ora19c> show parameter db_recovery_file_dest 
    
    NAME                                 TYPE        VALUE
    ------------------------------------ ----------- ------------------------------
    db_recovery_file_dest                string      /u01/app/oracle/fast_recovery_
    db_recovery_file_dest_size           big integer 8256M
    ```
    
- ARCHIVELOG 설정
    
    ```sql
    SYS@ora19c> select log_mode from v$database;   -- 모드 조회 
    
    LOG_MODE
    ------------
    NOARCHIVELOG
    
    SYS@ora19c> !
    [oracle@oracle ~]$ cd $ORACLE_BASE
    [oracle@oracle oracle]$ ls
    admin  audit  cfgtoollogs  checkpoints  diag  fast_recovery_area  oradata  product
    [oracle@oracle oracle]$ cd fast_recovery_area
    [oracle@oracle fast_recovery_area]$ ls
    ORA19C
    [oracle@oracle fast_recovery_area]$ cd ORA19C
    [oracle@oracle ORA19C]$ ls
    archivelog  onlinelog
    
    -- 설정 위치 
    /u01/app/oracle/fast_recovery_area/ORA19C/archivelog
    
    ```
    
    1️⃣ 데이터베이스 정상적인 종료
    
    ```sql
    shutdown immediate
    ```
    
    2️⃣ 데이터베이스를 mount 까지만 시작
    
    ```sql
    startup mount
    ```
    
    3️⃣ archivelog 모드로 변경
    
    ```sql
    SYS@ora19c> alter database archivelog;
    SYS@ora19c> select log_mode from v$database;
    
    LOG_MODE
    ------------
    ARCHIVELOG
    
    ```
    
    4️⃣ 데이터베이스 open
    
    ```sql
    alter database open;
    
    SYS@ora19c> archive log list;
    Database log mode              Archive Mode
    Automatic archival             Enabled
    Archive destination            USE_DB_RECOVERY_FILE_DEST
    Oldest online log sequence     9
    Next log sequence to archive   11
    Current log sequence           11
    ```
    
- NOARCHIVELOG 설정
    
    
    1️⃣ 데이터베이스 정상적인 종료
    
    ```sql
    shutdown immediate
    ```
    
    2️⃣ 데이터베이스를 mount까지만 시작
    
    ```sql
    startup mount
    ```
    
    3️⃣ noarchivelog mode로 변경
    
    ```sql
    alter database noarchivelog;
    ```
    
    4️⃣ 데이터베이스 open
    
    ```sql
    alter database open;
    SYS@ora19c> select log_mode from v$database;
    
    LOG_MODE
    ------------
    NOARCHIVELOG
    ```
    
- 실습
    
    📍 아카이브 모드
    
    - 📍 확인 작업
        
        ```sql
        -- 리두 로그 정보 
        
        SYS@ora19c> SELECT a.group#, b.sequence#, a.member, b.status, b.first_change#, b.first_time, b.next_change#, b.next_time
        FROM v$logfile a, v$log b
        WHERE a.group# = b.group#
        ORDER BY b.group#;
        
           
             GROUP#  SEQUENCE# MEMBER
        ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                 1         16 /u01/app/oracle/oradata/ORA19C/redo01.log
                 2         17 /u01/app/oracle/oradata/ORA19C/redo02.log
                 3         15 /u01/app/oracle/oradata/ORA19C/redo03.log
        
                 
        -- 📌 데이터파일 및 테이블스페이스 상태 확인
        SYS@ora19c> SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
        FROM v$datafile a, v$tablespace b
        WHERE a.ts# = b.ts#; 
        
          FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
        ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                 3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2965060
                 1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2965060
                 4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2965060
                 7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2965060
        
        ```
        
        2️⃣ 정상종료
        
        ```sql
        shutdown immediate
        ```
        
    - 📍백업
        - 📍 일관성 있는 백업 (consistent backup, closed backup, cold backup, offline backup)
            - 1️⃣ 정상 종료 후 backup/arch/close 경로에 백업본 만들기
                
                ```sql
                SYS@ora19c> shutdown immediate
                SYS@ora19c> !
                
                -- close 폴더 만들고 백업
                [oracle@oracle arch]$ mkdir close
                [oracle@oracle arch]$ cd close
                [oracle@oracle close]$ pwd
                /home/oracle/backup/arch/close
                
                -- 현재 폴더에다 ctl, log, dbf 파일들 복사하겠다
                [oracle@oracle close]$ cp -v /u01/app/oracle/oradata/ORA19C/*.{ctl,log,dbf} .
                ```
                
            - 2️⃣ sqlplus 접속해서 pfile 백업하기
                
                ```sql
                [oracle@oracle close]$ sqlplus / as sysdba
                SYS@ora19c> create pfile='/home/oracle/backup/arch/close/initora19c.ora' from spfile;
                
                -- 확인 작업
                SYS@ora19c> ! ls /home/oracle/backup/arch/close/
                
                ▶️ control01.ctl  data01.dbf  initora19c.ora  redo01.log  redo02.log  redo03.log  sysaux01.dbf  system01.dbf  temp01.dbf  undotbs01.dbf  users01.dbf
                
                ```
                
            - 3️⃣ 리두 로그 정보 확인, 데이터 파일, 테이블 스페이스 상태 확인
                
                ```sql
                select a.group#, b.sequence#, a.member, b.bytes/1024/1024 mb, b.archived,
                       b.status, b.first_change#, b.first_time, b.next_change#, b.next_time
                from v$logfile a, v$log b
                where a.group# = b.group#
                order by b.group#; 
                
                    GROUP#  SEQUENCE# MEMBER
                ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                         1         16 /u01/app/oracle/oradata/ORA19C/redo01.log
                         2         17 /u01/app/oracle/oradata/ORA19C/redo02.log
                         3         15 /u01/app/oracle/oradata/ORA19C/redo03.log
                
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#; 
                
                     FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
                ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                         3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2965060
                         1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2965060
                         4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2965060
                         7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2965060
                
                ```
                
            
        - 📍 일관성 없는 백업 (online , open, hot)
            - 1️⃣ 백업 정보 확인
                
                ```sql
                -- 일관성 없는 백업본을 체크하는 쿼리
                -- 데이터베이스 운영 중에 백업
                select a.name, a.checkpoint_change#, b.status, b.change#, b.time
                from v$datafile a, v$backup b where a.file# = b.file#;
                
                NAME                                               CHECKPOINT_CHANGE# STATUS                CHANGE# TIME
                -------------------------------------------------- ------------------ ------------------ ---------- ---------
                /u01/app/oracle/oradata/ORA19C/system01.dbf                   2965060 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                   2965060 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                  2965060 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/users01.dbf                    2965060 NOT ACTIVE            2847704 21-JUL-25
                
                ```
                
            - 2️⃣ open backup 수행 (full check point 발생해야 함)
                
                ```sql
                -- 데이터베이스 전체를 백업 모드로 전환
                -- RMAN이 아닌 OS 수준의 수동 파일 복사(cp) 를 이용할 때
                -- 데이터베이스를 내리지 않고(OPEN 상태) 백업을 수행하고자 할 때
                alter database begin backup;
                
                -- 백업 정보 확인
                SYS@ora19c> select a.name, a.checkpoint_change#, b.status, b.change#, b.time
                from v$datafile a, v$backup b where a.file# = b.file#;
                
                NAME                                               CHECKPOINT_CHANGE# STATUS                CHANGE# TIME
                -------------------------------------------------- ------------------ ------------------ ---------- ---------
                /u01/app/oracle/oradata/ORA19C/system01.dbf                   2967063 ACTIVE                2967063 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                   2967063 ACTIVE                2967063 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                  2967063 ACTIVE                2967063 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/users01.dbf                    2967063 ACTIVE                2967063 21-JUL-
                ```
                
            - 3️⃣ 모든 데이터 파일 백업
                
                home/oracle/backup/arch/open 경로에 백업
                
                ```sql
                ! cp -v /u01/app/oracle/oradata/ORA19C/*.dbf  /home/oracle/backup/arch/open/
                ls
                exit
                alter database end backup;
                ```
                
        - 📍 online control file 백업
            
            ```sql
            select name from v$controlfile;
            
            NAME
            --------------------------------------------------
            /u01/app/oracle/oradata/ORA19C/control01.ctl
            
            ALTER DATABASE BACKUP CONTROLFILE TO '/home/oracle/backup/arch/open/control01.ctl';
            
            ! ls /home/oracle/backup/arch/open/
            
            --  REDO 로그 파일 정보 확인
            SELECT a.group#, b.sequence#, a.member, b.bytes/1024/1024 mb, 
                   b.archived, b.status, b.first_change#, b.first_time, 
                   b.next_change#, b.next_time
            FROM v$logfile a, v$log b
            WHERE a.group# = b.group#
            ORDER BY b.group#;
            
                GROUP#  SEQUENCE# MEMBER
            ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                     1         10 /u01/app/oracle/oradata/ORA19C/redo01.log
                     2         11 /u01/app/oracle/oradata/ORA19C/redo02.log
                     3          9 /u01/app/oracle/oradata/ORA19C/redo03.log
            
            -- 현재 백업을 수행했을 때 리두 정보가 있는 current redo log file 를 archive 받자
            -- 내부적으로 강제로 log switch 유발 ( 1. 체크포인트 2. 리두 로그 아카이브)
            alter system archive log current;
            
            -- 새로운 그룹으로 current 한 그룹 바뀌었다.
                GROUP#  SEQUENCE# MEMBER
            ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                     1         10 /u01/app/oracle/oradata/ORA19C/redo01.log
                     2         11 /u01/app/oracle/oradata/ORA19C/redo02.log
                     3         12 /u01/app/oracle/oradata/ORA19C/redo03.log
            
            -- 확인해보기
            [oracle@oracle ~]$ cd $ORACLE_BASE
            [oracle@oracle oracle]$ ls
            admin  audit  cfgtoollogs  checkpoints  diag  fast_recovery_area  oradata  product
            [oracle@oracle oracle]$ cd fast_recovery_area
            [oracle@oracle fast_recovery_area]$ ls
            ORA19C
            [oracle@oracle fast_recovery_area]$ cd ORA19C
            [oracle@oracle ORA19C]$ ls
            archivelog  onlinelog
            [oracle@oracle ORA19C]$ cd archivelog
            [oracle@oracle archivelog]$ ls
            2025_07_01  2025_07_02  2025_07_03  2025_07_07  2025_07_09  2025_07_14  2025_07_15  2025_07_16  2025_07_17  2025_07_21
            [oracle@oracle archivelog]$ cd 2025_07_21
            [oracle@oracle 2025_07_21]$ ls
            o1_mf_1_11_n7vlytjz_.arc
            
            -- 다른 세션
            SYS@ora19c> alter system archive log current;
            
            System altered.
            
            SYS@ora19c> SELECT a.group#, b.sequence#, a.member, b.bytes/1024/1024 mb,
                   b.archived, b.status, b.first_change#, b.first_time,
                   b.next_change#, b.next_time
            FROM v$logfile a, v$log b
            WHERE a.group# = b.group#
            order by 1;
            
                GROUP#  SEQUENCE# MEMBER
            ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                     1         13 /u01/app/oracle/oradata/ORA19C/redo01.log
                     2         11 /u01/app/oracle/oradata/ORA19C/redo02.log
                     3         12 /u01/app/oracle/oradata/ORA19C/redo03.log
            
            -- 현재 online backup 정보 확인
            -- 백업 시점 scn : 2849125 
            -- 백업 이후 로그 시퀀스 정보들 : #11, #12, #13
            select a.name, a.checkpoint_change#, b.status, b.change#, b.time
            from v$datafile a, v$backup b
            where a.file# = b.file#;
            
            NAME                                               CHECKPOINT_CHANGE# STATUS                CHANGE# TIME
            -------------------------------------------------- ------------------ ------------------ ---------- ---------
            /u01/app/oracle/oradata/ORA19C/system01.dbf                   2849125 NOT ACTIVE            2847704 21-JUL-25
            /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                   2849125 NOT ACTIVE            2847704 21-JUL-25
            /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                  2849125 NOT ACTIVE            2847704 21-JUL-25
            /u01/app/oracle/oradata/ORA19C/users01.dbf                    2849125 NOT ACTIVE            2847704 21-JUL-25
            
            SELECT a.group#, b.sequence#, a.member, b.bytes/1024/1024 mb,
                   b.archived, b.status, b.first_change#, b.first_time,
                   b.next_change#, b.next_time
            FROM v$logfile a, v$log b
            WHERE a.group# = b.group#
            order by 1;
            
               GROUP#  SEQUENCE# MEMBER
            ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                     1         13 /u01/app/oracle/oradata/ORA19C/redo01.log
                     2         11 /u01/app/oracle/oradata/ORA19C/redo02.log
                     3         12 /u01/app/oracle/oradata/ORA19C/redo03.log
            
            -- 백업 시점, 현재 시점 로그 정보 확인 (컨트롤 파일 안에 저장되어 있다.- 논리적)
            SELECT sequence#, name, first_change#, next_change# 
            FROM v$archived_log;
            
             SEQUENCE# NAME                                               FIRST_CHANGE# NEXT_CHANGE#
            ---------- -------------------------------------------------- ------------- ------------
                    11 /u01/app/oracle/fast_recovery_area/ORA19C/archivel       2767692      2849125  <- 백업시점 scn
                    12 /u01/app/oracle/fast_recovery_area/ORA19C/archivel       2849125      2849255
            
            -- 물리적인 아카이브 파일 꼭 체크
            ! ls /u01/app/oracle/fast_recovery_area/ORA19C/archivelog/2025_07_21
            
            o1_mf_1_11_n7vlytjz_.arc  o1_mf_1_12_n7vm7v41_.arc
            
            ```
            
    - 📍복구
        - 📍 데이터베이스 운영 중에 non system datafile 손상되었을 경우 복구
            - 1️⃣ 데이터 생성
                
                ```sql
                create table hr.new(id number) tablespace users;
                insert into hr.new(id) values(1);
                commit;
                ```
                
            - 2️⃣ 장애 발생
                
                ```sql
                SELECT f.file_name
                FROM dba_extents e, dba_data_files f
                WHERE e.file_id = f.file_id
                  AND e.segment_name = 'NEW'
                  AND e.owner = 'HR';
                  
                -- 장애 발생 
                ! ls /u01/app/oracle/oradata/ORA19C/users01.dbf
                ! rm /u01/app/oracle/oradata/ORA19C/users01.dbf
                ! ls /u01/app/oracle/oradata/ORA19C/users01.dbf
                
                -- 복구 필요 여부 확인, 특정 테이블스페이스에 속한 파일 확인, 체크포인트 동기화 점검,  RMAN 또는 수동 복구 전 점검
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                
                     FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
                ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                         3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2849255
                         1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2849255
                         4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2849255
                         7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2849255
                
                -- users01.dbf 삭제되었기 때문에 오류 발생 
                CREATE TABLE hr.new_emp 
                TABLESPACE users 
                AS 
                SELECT * FROM hr.employees;
                
                SYS@ora19c> select count(*) from hr.employees;
                
                  COUNT(*)
                ----------
                       107
                
                SYS@ora19c> select * from hr.new
                  2  ;
                
                        ID
                ----------
                         1
                  
                ```
                
            - 3️⃣ 복구 작업
                
                **복구 수행해야할 테이블스페이스 offline**
                
                ```sql
                alter tablespace 테이블스페이스 이름 offline [normal | temporary | immediate]
                -- 📍 normal : 체크 포인트 발생하는 하나의 기능
                -- 📍 temporary : 가능한 체크포인트
                -- 📍 immediate : 체크 포인트 발생하지 않음.
                
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                
                -- 체크포인트 발생하지 말고 offline으로 변경
                alter tablespace users offline immediate;
                
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                
                 -- 7 USERS         /u01/app/oracle/oradata/ORA19C/users01.dbf RECOVER 
                ```
                
                **가장 최근 백업 파일 찾아서 restore**
                
                ```sql
                ! ls /home/oracle/backup/arch/open/users01.dbf
                /home/oracle/backup/arch/open/users01.dbf
                
                ! cp -v /home/oracle/backup/arch/open/users01.dbf /u01/app/oracle/oradata/ORA19C/
                ```
                
            
            **백업 이후 리두 정보 적용**
            
            ```sql
            recover tablespace users;
            ```
            
            **대상 테이블스페이스 oline 변경**
            
            ```sql
            alter tablespace users online;
            
            -- 확인
            
                FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
            ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                     3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2849255
                     1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2849255
                     4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2849255
                     7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2851811
            
            -- 확인 작업
            CREATE TABLE hr.new_emp 
            TABLESPACE users 
            AS 
            SELECT * FROM hr.employees;
            ```
            
                   **테스트용 테이블 삭제** 
            
            ```sql
            drop table hr.new_emp purge
            ```
            
        - 📍 데이터베이스 종료 후 non system datafile 손상되었을 경우
            - 1️⃣ 장애 유도
                
                ```sql
                shutdown immediate
                ! rm /u01/app/oracle/oradata/ORA19C/users01.dbf
                startup  -- 오류난다. 
                ```
                
            - 2️⃣ 문제되는 대상 파일 찾기
                
                ```sql
                select * from v$recover_file;
                
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                ```
                
            - 3️⃣ 복구 작**업**
                
                **대상 데이터 파일 offline**
                
                ```sql
                -- 아카이브 모드에서는 offline : 체크포인트 발생 안함.
                alter database datafile 7 offline;
                
                -- 확인
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#; 
                ```
                
            
            **데이터베이스 open**
            
            ```sql
            alter database open;
            
            SYS@ora19c> select count(*) from hr.employees;
            
              COUNT(*)
            ----------
                   107
            
            SYS@ora19c> select * from hr.new;
            select * from hr.new
                             *
            ERROR at line 1:
            ORA-00376: file 7 cannot be read at this time
            ORA-01110: data file 7: '/u01/app/oracle/oradata/ORA19C/users01.dbf'
            
            ```
            
            가장 최근 백업본 찾아서 restore
            
            ```sql
            ! cp -v /home/oracle/backup/arch/open/users01.dbf /u01/app/oracle/oradata/ORA19C/
            ```
            
            백업 이후 리두 정보 적용
            
            ```sql
            recover tablespace users;
            ```
            
                   복구 완료 데이터 파일 online 변경
            
            ```sql
            alter database datafile 7 online;
            
            -- 확인
            select * from hr.new;
            ```
            
        - 📍 데이터베이스 종료 후 여러 non system datafile 손상되었을 경우
            - 1️⃣ 장애 유도
                
                ```sql
                shutdown immediate
                
                # 파일 존재 확인
                ! ls /u01/app/oracle/oradata/ORA19C/{sysaux01,users01}.dbf
                
                # 두 파일 삭제
                ! rm /u01/app/oracle/oradata/ORA19C/{sysaux01,users01}.dbf
                
                # 삭제 확인
                ! ls /u01/app/oracle/oradata/ORA19C/{sysaux01,users01}.dbf
                
                startup
                -- startup 은 모든 recover 대상 파일을 조회하는 것은 아니다.
                -- alert.log 확인하자.
                -- 아니면 이렇게 확실하게 확인
                
                SYS@ora19c> select * from v$recover_file;
                
                     FILE# ONLINE  ONLINE_ ERROR                                                                CHANGE# TIME          CON_ID
                ---------- ------- ------- ----------------------------------------------------------------- ---------- --------- ----------
                         3 ONLINE  ONLINE  FILE NOT FOUND                                                             0                    0
                         7 ONLINE  ONLINE  FILE NOT FOUND                                                             0                    0
                
                SYS@ora19c> select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                
                  2    3
                     FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
                ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                         1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2854509
                         3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2854509
                         4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2854509
                         7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2854509
                
                ```
                
            - 2️⃣ 복구 수행
                
                복구 수행할 데이터 파일 offline 변경
                
                ```sql
                alter database datafile 3 offline;
                alter database datafile 7 offline;
                
                select a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                from v$datafile a, v$tablespace b
                where a.ts# = b.ts#;
                ```
                
            - 3️⃣ 데이터베이스 open
                
                ```sql
                alter database open;
                ```
                
            - 4️⃣ 가장 최근 백업본 찾아서 restore
                
                ```sql
                
                SYS@ora19c> ! cp -v /home/oracle/backup/arch/open/{sysaux01,users01}.dbf /u01/app/oracle/oradata/ORA19C
                
                ```
                
            - 5️⃣ 백업 이후 리두 정보 적용
                
                ```sql
                recover tablespace sysaux;
                recover tablespace users;
                ```
                
            - 6️⃣ 복구 완료 데이터파일 online 변경
                
                ```sql
                alter database datafile 3 online;
                alter database datafile 7 online;
                ```
                
            
        - 📍시스템 테이블스페이스 손상 복구
            - 1️⃣ 장애 유발
                
                ```sql
                ! rm /u01/app/oracle/oradata/ORA19C/system01.dbf
                
                == 새로운 세션에서 v$database 조회가능
                -- sys.obj$ 조회시 오류남.
                ```
                
            - 2️⃣ 데이터베이스 종료
                
                ```sql
                shutdown abort
                ```
                
            - 3️⃣ 데이터베이스 시작 (문제되는 파일 확인)
                
                ```sql
                startup
                
                select * v$recover_file;
                select status from v$instance;  --mounted 까지
                
                ```
                
            - 4️⃣ 최근 백업본 찾아서 restore
                
                ```sql
                ! ls /home/oracle/backup/arch/open/system01.dbf
                ! cp -v /home/oracle/backup/arch/open/system01.dbf /u01/app/oracle/oradata/ORA19C/
                ```
                
            - 5️⃣ 백업 이후 리두 정보 적용
                
                ```sql
                recover tablespace system
                ```
                
            - 6️⃣ 데이터베이스 open
                
                ```sql
                alter database open;
                ```
                
        - 📍 백업받지 않은 테이블스페이스 손상
            - 1️⃣ 데이터 생성
                
                ```sql
                create tablespace data_tbs datafile '/u01/app/oracle/oradata/ORA19C/data_tbs01.dbf' size 10m;
                
                -- 백업 정보 확인
                select a.name, a.checkpoint_change#, b.status, b.change#, b.time
                from v$datafile a, v$backup b
                where a.file# = b.file#;
                
                NAME                                               CHECKPOINT_CHANGE# STATUS                CHANGE# TIME
                -------------------------------------------------- ------------------ ------------------ ---------- ---------
                /u01/app/oracle/oradata/ORA19C/system01.dbf                   2854512 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                   2855666 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                  2854512 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf                 2856296 NOT ACTIVE                  0
                /u01/app/oracle/oradata/ORA19C/users01.dbf                    2855675 NOT ACTIVE            2847704 21-JUL-25
                
                -- change# -> 0, time : null 백업받지 않은 것
                
                create table hr.data_test(id number) tablespace data_tbs;
                insert into hr.data_test(id) values(1);
                commit; 
                
                -- 📌  리두 로그 정보 확인
                SELECT a.group#, b.sequence#, a.member, b.status, b.first_change#, b.first_time, b.next_change#, b.next_time
                FROM v$logfile a, v$log b
                WHERE a.group# = b.group#
                ORDER BY b.group#;
                
                    GROUP#  SEQUENCE# MEMBER
                ---------- ---------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                         1         13 /u01/app/oracle/oradata/ORA19C/redo01.log
                         2         11 /u01/app/oracle/oradata/ORA19C/redo02.log
                         3         12 /u01/app/oracle/oradata/ORA19C/redo03.log
                
                alter system switch logfile;
                /
                /
                
                ```
                
            - 2️⃣ 장애 발생
                
                ```sql
                ! ls /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf
                ! rm /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf
                ! ls /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf
                
                shutdown immediate
                ```
                
            - 3️⃣ 복구 진행
                
                ```sql
                conn / as sysdba
                ```
                
                데이터베이스 시작(문제 발생 확인)
                
                ```sql
                startup
                select * from v$recover_file;
                
                    FILE# ONLINE  ONLINE_ ERROR                                                                CHANGE# TIME          CON_ID
                ---------- ------- ------- ----------------------------------------------------------------- ---------- --------- ----------
                         5 ONLINE  ONLINE  FILE NOT FOUND                                                             0                    0
                
                -- 확인
                -- 📌 데이터파일 및 테이블스페이스 상태 확인
                SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                FROM v$datafile a, v$tablespace b
                WHERE a.ts# = b.ts#;
                
                     FILE# TBS_NAME                       FILE_NAME                                                              STATUS  CHECKPOINT_CHANGE#
                ---------- ------------------------------ ---------------------------------------------------------------------- ------- ------------------
                         1 SYSTEM                         /u01/app/oracle/oradata/ORA19C/system01.dbf                            SYSTEM             2857699
                         3 SYSAUX                         /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                            ONLINE             2857699
                         4 UNDOTBS1                       /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                           ONLINE             2857699
                         7 USERS                          /u01/app/oracle/oradata/ORA19C/users01.dbf                             ONLINE             2857699
                         5 DATA_TBS                       /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf                          ONLINE             2857699
                
                -- 백업 정보 확인
                
                select a.name, a.checkpoint_change#, b.status, b.change#, b.time
                from v$datafile a, v$backup b
                where a.file# = b.file#;
                
                NAME                                               CHECKPOINT_CHANGE# STATUS                CHANGE# TIME
                -------------------------------------------------- ------------------ ------------------ ---------- ---------
                /u01/app/oracle/oradata/ORA19C/system01.dbf                   2857699 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/sysaux01.dbf                   2857699 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/undotbs01.dbf                  2857699 NOT ACTIVE            2847704 21-JUL-25
                /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf                 2857699 FILE NOT FOUND              0
                /u01/app/oracle/oradata/ORA19C/users01.dbf                    2857699 NOT ACTIVE            2847704 21-JUL-25
                
                alter database datafile 5 offline;
                ```
                
                    
                
            - 4️⃣ 데이터베이스 open
                
                ```sql
                alter database open;
                
                -- 확인 select count(*) from hr.employees;
                ```
                
            - 5️⃣ 백업 받지 않은 테이블스페이스에 속한 파일 재생성
                
                ```sql
                ! ls /u01/app/oracle/oradata/ORA19C/data_tbs.dbf
                
                -- 재생성
                alter database create datafile '/u01/app/oracle/oradata/ORA19C/data_tbs01.dbf';
                
                ```
                
            
               📍 백업 받지 않은 테이블스페이스에 속한 파일 재생성
            
            ```sql
            alter databases create datafile '/u01/app/oracle/oradata/ORA19C/data_tbs01.dbf' as '/home/oracle/backup/
            
            ```
            
            - 6️⃣ 테이블스페이스 생성 시점부터 현재까지 리두 정보 적용
                
                ```sql
                recover tablespace data_tbs;
                
                -- alter.log 보면서 현재까지 리두 정보 적용
                ```
                
            - 7️⃣ 복구 완료된 대상 데이터 파일 online
                
                ```sql
                alter database datafile 5 online;
                ```
                
            
        - 📍 특정한 테이블스페이스에 대해서 백업
            
            ```sql
            alter tablespace data_tbs begin backup;
            -- 백업 정보 확인
            select a.name, a.checkpoint_change#, b.status, b.change#, b.time
            from v$datafile a, v$backup b
            where a.file# = b.file#;
            
            -- 물리적 장소에 카피
            ! cp -v /u01/app/oracle/oradata/ORA19C/data_tbs01.dbf /home/oracle/backup/arch/open
            
            alter tablespace data_tbs end backup;
            select a.name, a.checkpoint_change#, b.status, b.change#, b.time
            from v$datafile a, v$backup b
            where a.file# = b.file#;
            
            -- 현재 컨트롤파일 백업
            alter database backup controlfile to '/home/oracle/backup/arch/open/control01_202507211628.ctl';
            
            -- 현재 리두 정보를 archive 받자
            alter system archive log current;
            ```
            
        - 📍 테이블스페이스에 속한 여러 데이터 파일들 중에 특정한 파일이 손상되었을 경우
            
            ```sql
            SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
            FROM v$datafile a, v$tablespace b
            WHERE a.ts# = b.ts#;
            
            --  기존 테이블스페이스에 새 데이터파일 추가
            ALTER TABLESPACE data_tbs 
            ADD DATAFILE '/u01/app/oracle/oradata/ORA19C/data_tbs02.dbf' SIZE 5M;
            
            -- 추가 후 데이터파일 목록 재조회
            SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
            FROM v$datafile a, v$tablespace b
            WHERE a.ts# = b.ts#;
            
            --테이블스페이스의 총 용량 / 사용 용량 / 여유 공간을 MB 단위로 조회하는 쿼리
            SELECT a.tablespace_name,b.file_name,  b.bytes/1024/1024 "Total Size MB", (b.bytes - c.free_byte)/1024/1024 "Used Size MB", c.free_byte/1024/1024 "Free Size MB",  b.autoextensible
            FROM dba_tablespaces a, dba_data_files b,    (SELECT tablespace_name, file_id, sum(bytes) free_byte   
                                                           FROM dba_free_space    
                                                        GROUP BY tablespace_name, file_id) c
                                                        WHERE a.tablespace_name = b.tablespace_name
                                                        AND a.tablespace_name = c.tablespace_name
            AND b.file_id = c.file_id;
            
            --  HR 스키마의 DATA_TEST 세그먼트가 어떤 데이터파일(.dbf)에 존재하는지 조회
            SELECT f.file_name 
            FROM dba_extents e, dba_data_files f 
            WHERE e.file_id = f.file_id 
              AND e.segment_name = 'DATA_TEST' 
              AND e.owner = 'HR';
              
            -- 테이블 생성 
            CREATE TABLE hr.test_2025 
            TABLESPACE data_tbs 
            AS 
            SELECT * FROM hr.employees;  
            
            -- 확인
            SELECT f.file_name 
            FROM dba_extents e, dba_data_files f 
            WHERE e.file_id = f.file_id 
              AND e.segment_name = 'DATA_TEST' 
              AND e.owner = 'HR';
              
            -- 의도적으로 대량의 데이터 발생하게 
            INSERT INTO hr.test_2025 
            SELECT * FROM hr.test_2025;
            /
            /
            /
            /
            /...
            
            -- 확인
            SELECT f.file_name
            FROM dba_extents e, dba_data_files f
            WHERE e.file_id = f.file_id
              AND e.segment_name = 'TEST_2025'
              AND e.owner = 'HR';
            ```
            
           ![image.png](/assets/20250721/1.png)
            
            ```sql
            SELECT f.file_name, COUNT(*)
            FROM dba_extents e, dba_data_files f
            WHERE e.file_id = f.file_id
              AND e.segment_name = 'TEST_2025'
              AND e.owner = 'HR'
            GROUP BY f.file_name;
            
            --  테이블스페이스 사용량 조회 쿼리
            
            SELECT a.tablespace_name,
                   b.file_name,
                   b.bytes/1024/1024 AS "Total Size MB",
                   (b.bytes - c.free_byte)/1024/1024 AS "Used Size MB",
                   c.free_byte/1024/1024 AS "Free Size MB",
                   b.autoextensible
            FROM dba_tablespaces a,
                 dba_data_files b,
                 (SELECT tablespace_name, file_id, SUM(bytes) AS free_byte
                  FROM dba_free_space
                  GROUP BY tablespace_name, file_id) c
            WHERE a.tablespace_name = b.tablespace_name
              AND a.tablespace_name = c.tablespace_name
              AND b.file_id = c.file_id;
            ```
            
        - 📍특정한 테이블스페이스에 속한 데이터파일 백업
            - 백업
                
                ```sql
                alter tablespace data_tbs begin backup;
                ! cp -v /u01/app/oracle/oradata/ORA19C/data_tbs02.dbf /home/oracle/backup/arch/open/
                ALTER TABLESPACE data_tbs END BACKUP;
                
                select a.name, a.checkpoint_change#, b.status, b.change#, b.time
                from v$datafile a, v$backup b
                where a.file# = b.file#;
                
                !
                ```
                
            - 1️⃣ 장애 발생
                
                ```sql
                -- 📌특정 데이터 파일 경로 확인
                ! ls /u01/app/oracle/oradata/ORA19C/data_tbs02.dbf
                
                -- 📌장애 유발 (데이터 파일 손상)
                ! rm /u01/app/oracle/oradata/ORA19C/data_tbs02.dbf
                ```
                
            - 2️⃣ 복구 작업
                
                복구 수행해야할 테이블 스페이스에 대해서 offline temporary (가능한 파일들만 checkpoint 발생)
                
                ```sql
                alter tablespace data_tbs offline temporary
                
                -- 📌 데이터파일 및 테이블스페이스 상태 확인
                SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                FROM v$datafile a, v$tablespace b
                WHERE a.ts# = b.ts#;
                
                ```
                
                복구 수행해야할 데이터파일 백업을 찾아서 restore
                
                ```sql
                ! ls /home/oracle/backup/arch/open/data_tbs02.dbf
                ! cp -v /home/oracle/backup/arch/open/data_tbs02.dbf /u01/app/oracle/oradata/ORA19C/
                ```
                
                백업 이후 리두 정보 적용
                
                ```sql
                RECOVER TABLESPACE data_tbs;
                ```
                
                복구 작업 완료된 테이블스페이스 online
                
                ```sql
                ALTER TABLESPACE data_tbs ONLINE;
                
                SELECT a.file#, b.name tbs_name, a.name file_name, a.status, a.checkpoint_change#
                FROM v$datafile a, v$tablespace b
                WHERE a.ts# = b.ts#;
                
                SELECT COUNT(*) FROM hr.test_2025;
                
                COUNT(*)
                --------
                54784
                ```
                
                테스트용 삭제
                
                ```sql
                DROP TABLESPACE data_tbs INCLUDING CONTENTS AND DATAFILES;
                
                ! ls /home/oracle/backup/arch/open/data_tbs{01,02}.dbf
                ! rm /home/oracle/backup/arch/open/data_tbs{01,02}.dbf
                ! rm -i /home/oracle/backup/arch/open/control01_202507211628.ctl
                ```