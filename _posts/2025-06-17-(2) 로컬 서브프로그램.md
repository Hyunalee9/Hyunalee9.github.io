# Local subprogram

# Î°úÏª¨ ÏÑúÎ∏åÌîÑÎ°úÍ∑∏Îû®(nested subprogram)

- Î°úÏª¨ ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû®ÏùÄ ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû®Ïùò ÏÑ†Ïñ∏ ÏÑπÏÖò ÎÅùÏóê Ï†ïÏùòÎêú **ÌîÑÎ°úÏãúÏ†Ä, Ìï®Ïàò**Ïù¥Îã§. (ÏùµÎ™Ö Î∏îÎ°ù Íµ¨Ï°∞ÏóêÏÑúÎèÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎã§.)
- Ï§ëÎ≥µÎêòÎäî ÏΩîÎìúÎ•º Ï†úÍ±∞Ìï®ÏúºÎ°úÏÑú Î™®Îìà ÌÅ¨Í∏∞Î•º Ï§ÑÏùº Ïàò ÏûàÎã§.
- **ÏΩîÎìú Í∞ÄÎèÖÏÑ±Ïù¥ Ìñ•ÏÉÅÎêòÍ≥† Ïú†ÏßÄ Í¥ÄÎ¶¨ ÏâΩÎã§**.
- Î≥ÑÎèÑÏùò Í∂åÌïú ÏóÜÏù¥ ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû®ÏùÑ ÎßåÎì§ Ïàò ÏûàÎã§. (ÏõêÎûòÎäî ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû® ÎßåÎìúÎ†§Î©¥, CREATE PROCEDURE ÌïÑÏöîÌïòÎã§.)
- ÏùµÎ™Ö Î∏îÎ°ù Íµ¨Ï°∞Îäî CREATE SESSION , Ï¶â ÎîîÎπÑÏóê Ï†ëÏÜçÎßå Ìï† Ïàò ÏûàÏùå Î≥ÑÎèÑÏùò Í∂åÌïú ÏóÜÏù¥ ÎßåÎì§ Ïàò ÏûàÎã§.

```sql
-- Ïù¥ ÌîÑÎ°úÍ∑∏Îû® ÏïàÏóêÏÑúÎßå ÏÇ¨Ïö©ÌïòÎäî Ìï®Ïàò, ÌîÑÎ°úÏãúÏ†Ä ÎßåÎì§Í≥† Ïã∂Îã§.
--> DECLARE ÏïàÏóê CREATE Î∂ôÏù¥ÏßÄ ÏïäÍ≥† Ï†ïÏùòÌïòÎùº.
-- ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû® ÎÅùÏóê Î≥ÄÏàòÏÑ†Ïñ∏, ÏòàÏô∏ÏÇ¨Ìï≠ Îì± ÏûëÏÑ±ÌïòÎ©¥ ÏïàÎê®.

DECLARE
		    TYPE emp_id_type IS TABLE OF number;
		    v_id emp_id_type := emp_id_type(100,101,200);
		    v_rec employees%rowtype; 
		    
		    --Ìï®Ïàò  
		    FUNCTION tax(p_sal IN number)
		    RETURN number
		    IS
		    BEGIN
		        RETURN p_sal * 0.8;
		    END tax;
		    
		    --ÌîÑÎ°úÏãúÏ†Ä
		    PROCEDURE message
		    IS
		    BEGIN
		        dbms_output.put_line('ÍøàÏùÑ Ïù¥Î£®Ïûê.');
		    END message;
    
BEGIN
				FOR i IN v_id.first..v_id.last LOOP
						SELECT *
						INTO v_rec
						FROM hr.employees
					 WHERE employee_id = v_id(i);
					 
					 dbms_output.put_line('ÏÇ¨Î≤à : '||v_rec.employee_id || ' Tax : '|| v_rec.salary );
				END LOOP;
END;
/

/*

ÏÇ¨Î≤à : 100 Tax : 24000
ÏÇ¨Î≤à : 101 Tax : 17000
ÏÇ¨Î≤à : 200 Tax : 4400

*/
```

```sql
CREATE OR REPLACE PROCEDURE hr.emp_sal(p_id IN number)
IS
		    v_rec employees%rowtype;
		    
		    FUNCTION tax(p_sal IN number)
		    RETURN number
		    IS
		    BEGIN
		        RETURN p_sal * 0.8;
		    END tax;
BEGIN
		    SELECT *
		    INTO v_rec
		    FROM hr.employees
		    WHERE employee_id = p_id;
		    
		    dbms_output.put_line('ÏÇ¨Î≤à :'||v_rec.employee_id || 'Tax : '|| tax(v_rec.salary));
END emp_sal;
/

execute hr.emp_sal(100)

-- ÏÇ¨Î≤à :100Tax : 19200
```

## üå≥ Î¨∏Îß• Ï†ÑÌôòÏùÑ Ï§ÑÏù¥Îäî Î∞©Î≤ï

üìå  **Î¨∏Îß• Ï†ÑÌôò (context switching)**

   PL/SQL ÏóîÏßÑÍ≥º SQL ÏóîÏßÑ ÏÇ¨Ïù¥ÏóêÏÑú Ï†úÏñ¥Í∂åÏù¥ Ï†ÑÌôòÎêòÎäî ÌòÑÏÉÅ (ÏÑ±Îä• Ï†ÄÌïò)

‚Üí ÎëòÏùÄ ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÎèôÏûëÌïòÎØÄÎ°ú, **Í∞ÅÏûêÏùò Ïó≠Ìï†ÏùÑ ÏàòÌñâÌï† ÎïåÎßàÎã§ Ï†ÑÌôòÏù¥ ÌïÑÏöî**Ìï®

1Ô∏è‚É£ SQL ‚Üí PLSQL ( Î™ÖÏãúÏ†Å Ïª§ÏÑú FETCH ÏãúÏ†ê) BULK COLLECT

2Ô∏è‚É£ PLSQL ‚Üí SQL ( PLSQLÏùò Î∞òÎ≥µÎ¨∏ ÏïàÏóê DML ÎèåÏïÑÍ∞à Îïå)

## 1. BULK COLLECT

‚û°  Î™ÖÏãúÏ†Å Ïª§ÏÑúÏùò  FETCH Ïãú,  Î¨∏Îß• Ï†ÑÌôò ÎßéÏù¥ ÏùºÏñ¥ÎÇ†ÏàòÎ°ù ÏÑ±Îä•ÏùÄ Îñ®Ïñ¥ÏßÑÎã§.

üìå **Ìå®Ïπò ÏãúÏ†êÏóê** ÏÑ±Îä• ÎÜíÏù¥ÎèÑÎ°ù ÌïúÎ≤àÏóê Î¨∏Îß• Ï†ÑÌôòÌïòÎäî Î∞©Î≤ïÏùÄ?  **BULK COLLECT**

üìå Ïò§ÎùºÌÅ¥ ÏÑúÎ≤ÑÎäî Îëê Í∞úÏùò ÏóîÏßÑÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ PL / SQL Î∏îÎ°ùÍ≥º ÏÑúÎ∏å ÌîÑÎ°úÍ∑∏Îû®ÏùÑ Ïã§ÌñâÌïúÎã§.

- PLSQL ÏóîÏßÑ : ÌîÑÎ°úÏãúÏ†ÄÎ¨∏ÏùÑ Ïã§ÌñâÌïòÏßÄÎßå SQLÎ¨∏ÏùÄ SQLÏóîÏßÑÏóê Ï†ÑÎã¨ÌïúÎã§.
- SQLÏóîÏßÑ : SQLÎ¨∏ÏùÑ Íµ¨Î¨∏ Î∂ÑÏÑù, Ïã§ÌñâÌïòÍ≥† SELECTÎ¨∏Ïùò Ïã§Ìñâ Í≤∞Í≥ºÎ•º PLSQL ÏóîÏßÑÏóê Ï†ÑÎã¨ÌïúÎã§. (FETCH)

   

üìå BULK COLLECT INTO Ï†à (9i)

- **SQL ÏóîÏßÑÍ≥º PLSQLÏóîÏßÑ ÏÇ¨Ïù¥Ïùò Î¨∏Îß• Ï†ÑÌôòÏùÑ Ï§ÑÏù¥Îäî Î∞©Î≤ï**
- Î™ÖÏãúÏ†Å Ïª§ÏÑúÎ•º ÏÇ¨Ïö©ÏãúÏóê FETCHÏãúÏ†êÏù¥ Î¨∏Îß• Ï†ÑÌôòÏù¥ ÎßéÏù¥ Î∞úÏÉùÌïúÎã§. Ïù¥Î•º Ìï¥Í≤∞ÌïòÍ∏∞ ÏúÑÌï¥ÏÑú BULK COLLECT INTO Ï†àÏù¥ ÎÇòÏôîÎã§.

```sql
DECLARE
    TYPE tab_type IS TABLE OF employees%rowtype INDEX BY pls_integer;
    v_tab tab_type;
BEGIN
    SELECT *
    BULK COLLECT INTO v_tab
    FROM hr.employees
    WHERE department_id = 20;
    
    FOR i IN v_tab.first..v_tab.last LOOP
        dbms_output.put_line(v_tab(i).last_name||' '||v_tab(i).first_name);
    END LOOP;
END;
/
```

‚û° ÏÑ±Îä•ÎèÑ Ï±ôÍ∏∞Í≥†(Ïã§Ìñâ Í≥ÑÌöç Í≥µÏú†) , Ï†àÏ∞®ÎåÄÎ°ú Ïª§ÏÑú ÏÇ¨Ïö©

üìå ÌååÎùºÎØ∏ÌÑ∞Î•º ÏÇ¨Ïö©Ìïú Ïª§ÏÑú

```sql
DECLARE
	CURSOR emp_cur(p_id number) IS
		SELECT *
		FROM hr.employees
		WHERE department_id = p_id;
	TYPE tab_type IS TABLE OF emp_cur%rowtype;
	v_tab tab_type; 
BEGIN
	OPEN emp_cur(20);
	FETCH emp_cur BULK COLLECT INTO v_tabl
	CLOSE emp_cur;
	
	FOR i IN v_tab.first..v_tab.last LOOP
			dbms_output.put.line(v_tab(i).employee_id||' ' ||v_tab(i).firsst_name);
	END LOOP;
	
	OPEN emp_cur(50);
	FETCH emp_cur BULK COLLECT INTO v_tab;  --FETCH ÏãúÏ†êÏóêÎèÑ Í∞ÄÎä•ÌïòÎã§.
	CLOSE emp_cur;
	
	FOR i IN v_tab.first..v_tab.last LOOP
			dbms_output.put.line(v_tab(i).employee_id||' ' ||v_tab(i).firsst_name);
	END LOOP;
END;
/
```

‚û° ex) SELECT Ï†àÏóêÏÑúÎèÑ BULKÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎã§.

```sql
DECLARE
		TYPE record_type IS RECORD(id number, name varchar2(30));
		TYPE tab_type IS TABLE OF record_type INDEX BY pls_integer;
		v_tab tab_type;
BEGIN

SELECT e.employee_id, d.department_name
BULK COLLECT INTO v_tab 
FROM hr.employees e, hr.departments d
WHERE e.department_id = d.department_id;

FOR i IN v_tab.first..v_tab.last LOOP
		dbms_output.put_line(v_tab(i).id||' '||v_tab(i).name);
END LOOP;

END;
```

## 2. FORALL

‚û° FORALL Î¨∏

- PLSQL ÏóîÏßÑÍ≥º SQLÏóîÏßÑ ÏÇ¨Ïù¥Ïùò Î¨∏Îß•Ï†ÑÌôòÏùÑ Ï§ÑÏù¥Îäî Î¨∏
- Î∞òÎ≥µÎ¨∏ÏïàÏóê DMLÎ¨∏Ïù¥ ÏûàÎäî Í≤ΩÏö∞ FORALLÎ¨∏ÏúºÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ Î¨∏Îß•Ï†ÑÌôò Ï§ÑÏùº Ïàò ÏûàÎã§.

```sql
-- PLSQL -> SQL Î¨∏Îß• Ï†ÑÌôò.. ÏÑ±Îä• Í∞úÏÑ† -> FOR ALL
DECLARE
    TYPE numlist IS TABLE OF number;
    num_tab numlist := numlist(10,20,30);
BEGIN
    FORALL i IN num_tab.first..num_tab.last
    DELETE FROM hr.emp WHERE department_id = num_tab(i);
    
    dbms_output.put_line('Deleted '||sql%rowcount||'row(s)');
END;
/
--Deleted 9row(s)
rollback;
```

```sql
DECLARE
    TYPE numlist IS TABLE OF number;
    num_tab numlist := numlist(10,20,30);
BEGIN
    FORALL i IN num_tab.first..num_tab.last

    DELETE FROM hr.emp WHERE department_id = num_tab(i);
    
   FOR i IN num_tab.first..num_tab.last LOOP
        dbms_output.put_line('Deleted '||sql%bulk_rowcount(i)||'row(s)');
   END LOOP;
   
   dbms_output.put_line('Deleted '||sql%rowcount||'row(s)');
END;
/
```

‚û° EXCEPTION Ï≤òÎ¶¨ 

```sql
DECLARE 
    TYPE numlist IS TABLE OF number;
    num_tab numlist := numlist(10,11,20,0,15,40,0,30,100,2,0);
BEGIN
    FORALL i IN num_tab.first..num_tab.last
        DELETE FROM hr.emp WHERE salary > 500000/num_tab(i);
END;
/

----> Ïò§Î•òÍ∞Ä ÎÇúÎã§. 

DECLARE 
    TYPE numlist IS TABLE OF number;
    num_tab numlist := numlist(10,11,20,0,15,40,0,30,100,2,0);
BEGIN
    FORALL i IN num_tab.first..num_tab.last
        DELETE FROM hr.emp WHERE salary > 500000/num_tab(i);
EXCEPTION
    WHEN zero_divide THEN
        dbms_output.put_line('0ÏúºÎ°ú ÎÇòÎàå Ïàò ÏóÜÏäµÎãàÎã§.');
        rollback;
END;
/

```

‚û° Ïò§Î•ò Ïù¥Î¶Ñ Ï†ïÏùò ÌõÑ Ïò§ÎùºÌÅ¥ Ïò§Î•ò Î≤àÌò∏Îûë Î¨∂Îäî ÏûëÏóÖ.

```sql
DECLARE 
    TYPE numlist IS TABLE OF number;
    num_tab numlist := numlist(10,11,20,0,15,40,0,30,100,2,0);
    
    forall_error EXCEPTION;
    PRAGMA EXCEPTION_INIT(forall_error, -24381);
    v_error number;
BEGIN
    FORALL i IN num_tab.first..num_tab.last SAVE EXCEPTIONS
                                            ---------> Î¨∏Ï†ú Ï≤òÎ¶¨ Ï§ëÍ∞Ñ ÏòàÏô∏ÏÇ¨Ìï≠Ïù¥ Î∞úÏÉùÌïòÎ©¥ Ï†ÄÏû•Ìï¥ÎÜìÍ≥† ÎÑòÏñ¥Í∞ÑÎã§.                                    
        DELETE FROM hr.emp WHERE salary > 500000/num_tab(i);
        ------> Ìä∏ÎûúÏû≠ÏÖòÏùÄ ÏÇ¥ÏïÑÏûàÎã§.
EXCEPTION
    WHEN forall_error THEN
        FOR i IN num_tab.first..num_tab.last LOOP
            dbms_output.put_line('Deleted '||sql%bulk_rowcount(i)||'row(s)');
        END LOOP;
        
        v_error := sql%bulk_exceptions.count; -- save ÏãúÏºúÎÜìÏùÄ Í±¥ÏàòÎ•º Î∞òÌôò
        dbms_output.put_line('Ïò§Î•ò Í±¥Ïàò : '||v_error);
        
        FOR i IN 1..v_error LOOP
            -- Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏¥ ÏöîÏÜå Î≤àÌò∏ Ï∂úÎ†•
            dbms_output.put_line(sql%bulk_exceptions(i).error_index);
            -- Ï≤´Î≤àÏß∏ Ïò§Î•òÎÇú ÏóêÎü¨ ÏΩîÎìú
            dbms_output.put_line(sqlerrm(-sql%bulk_exceptions(i).error_code));
        END LOOP;
        rollback;
END;
/

/*
Deleted 0row(s)
Deleted 0row(s)
Deleted 0row(s)
Deleted 0row(s)
Deleted 0row(s)
Deleted 6row(s)
Deleted 0row(s)
Deleted 0row(s)
Deleted 52row(s)
Deleted 0row(s)
Deleted 0row(s)
Ïò§Î•ò Í±¥Ïàò : 3
4
ORA-01476: divisor is equal to zero
7
ORA-01476: divisor is equal to zero
11
ORA-01476: divisor is equal to zero

*/
```

## RETURNING(9i)

- DML ÏûëÏóÖÏãúÏóê FETCHÏ†àÏùÑ ÏàòÌñâÌï† Ïàò ÏûàÎã§.

‚ñ∂Ô∏è Î∂àÌïÑÏöî ÏøºÎ¶¨ÎïåÎ¨∏Ïóê ioÎ∞úÏÉù

```sql
DECLARE
BEGIN
    SELECT salary
      INTO v_before
      FROM hr.emp
     WHERE employee_id = 200; 
     
     UPDATE hr.emp
     SET salary = salary * 1.1
     WHERE employee_id = 200;
     
     SELECT salary
     INTO v_after
     FROM hr.emp
     WHERE employee_id = 200;
     --------> UPDATEÎ¨∏Ïû•ÏùÄ fetch ÏïàÌï¥ÏÑú ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌï¥ Îã§Ïãú io Ïú†Î∞ú. Î∂àÌïÑÏöîÌïú ÏøºÎ¶¨ Î¨∏Ïû•Ïù¥ Îê† Ïàò ÏûàÎã§.
     
     dbms_output.put_lint('Ïù¥Ï†Ñ Í∏âÏó¨ : '||v_before);
     dbms_output.put_lint('Ïù¥Ï†Ñ Í∏âÏó¨ : '||v_after);
     
     rollback;

END;
/
```

‚ñ∂Ô∏è RETURNING Î¨∏Ïû•ÏúºÎ°ú ÏÑ±Îä• Í∞úÏÑ†

```sql
DECLARE
BEGIN
    SELECT salary
      INTO v_before
      FROM hr.emp
     WHERE employee_id = 200; 
     
     UPDATE hr.emp
     SET salary = salary * 1.1
     WHERE employee_id = 200
     RETURNING salary INTO v_after;
        
     dbms_output.put_lint('Ïù¥Ï†Ñ Í∏âÏó¨ : '||v_before);
     dbms_output.put_lint('Ïù¥Ï†Ñ Í∏âÏó¨ : '||v_after);
     
     rollback;

END;
/

-----> Ïª¨Îüº 2Í∞ú Ïù¥ÏÉÅ
DECLARE
    v_before number;
    v_after number;
    v_name varchar2(30);
BEGIN
    SELECT salary
      INTO v_before
      FROM hr.emp
     WHERE employee_id = 200; 
     
     UPDATE hr.emp
     SET salary = salary * 1.1
     WHERE employee_id = 200
     -- RETURNINGÎ¨∏Ïû• *ÏïàÎêúÎã§ Í∞úÎ≥Ñ Ïª¨Îüº ÎÇòÏó¥Ìï¥ÏïºÌïúÎã§.
     RETURNING last_name, salary INTO v_name, v_after;
     
     rollback;

END;
/
```

‚ñ∂Ô∏è ÎèôÏùºÌïú ÌÖåÏù¥Î∏îÏùÑ Ï§ëÎ≥µ Ï°∞ÌöåÌïòÎäî Í≤ÉÏùÑ Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ÏÑú RETURNING + BULK  ‚áí SELECT + UPDATE  

```sql
DECLARE
     TYPE emplist IS TABLE OF number;
     emp_ids emplist := emplist(100,102,105,200);
     
     TYPE rec_type IS RECORD(id number, job varchar2(20), sal number);
     TYPE tab_type IS TABLE OF rec_type;
     emp_tab tab_type;
BEGIN
--> PLSQLÍ≥º SQL ÏÇ¨Ïù¥Ïùò Î¨∏Îß•Ï†ÑÌôò
     FORALL i IN emp_ids.first..emp_ids.last
             UPDATE hr.emp
             SET salary = salary * 1.1
             WHERE employee_id = emp_ids(i)
             RETURNING employee_id, job_id, salary BULK COLLECT INTO emp_tab;
             
             
     FOR i IN emp_tab.first..emp_tab.last LOOP
        dbms_output.put_line(emp_tab(i).id||' '||emp_tab(i).job||' '||emp_tab(i).sal);
     END LOOP;
     
     ROLLBACK;
END;
/
```