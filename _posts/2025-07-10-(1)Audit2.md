---
title: "Audit2"
excerpt: "ì•„ì´í‹°ìœŒ 0710_(1)"
categories:
      - ORACLE11g
tags:
      - ORACLE11g
      - TIL
last-modified-at: 2025-07-10T18:01
---

## Fine Grained Auditing(FGA)

- ì§ì—­í•˜ë©´ ì„¸ë°€í•œ ê°ì‚¬
- íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë  ë•Œë§Œ ê°ì‚¬ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë°©ì‹

ê¸°ì¡´ì˜ ê°ì‚¬ (Statement Audit, Object Audit ë“±)ëŠ”

- **ëˆ„ê°€ SELECT í–ˆë‹¤**ë§Œ ê¸°ë¡

---

### FGAëŠ”

- **ëˆ„ê°€ SELECT í–ˆê³ , ì–´ë–¤ ì¡°ê±´(ì˜ˆ: ê¸‰ì—¬ > 10000)ì´ì—ˆëŠ”ì§€ê¹Œì§€ ê°ì‚¬ ê°€ëŠ¥**
- ì •ë°€í•˜ê³  ì¡°ê±´ ê¸°ë°˜ìœ¼ë¡œ ê°ì‚¬í•  ìˆ˜ ìžˆëŠ” ê³ ê¸‰ ê¸°ëŠ¥ì´ë‹¤.
    
    ì¡°ê±´ ê¸°ë°˜ì´ë¼ê³  í•´ì„œ **WHERE ì ˆì˜ ì¡°ê±´ë§Œ** ìƒê°í•˜ë©´ ì•ˆ ëœë‹¤.
    
    ì˜ˆ: `SELECT *`
    
- `DBMS_FGA` íŒ¨í‚¤ì§€ë¡œ ì •ì˜
- `DBA_FGA_AUDIT_TRAIL` ë·°ì— ê¸°ë¡
- ì •ì±… ì´ë¦„ `(policy_name)`ì„ ê³ ìœ í•˜ê²Œ í•œë‹¤.
- ì •ì±… ìƒì„±ì‹œì— ê°ì‚¬ ë˜ëŠ” **í…Œì´ë¸” ë˜ëŠ” ë·°ê°€ ì¡´ìž¬í•´ì•¼** í•œë‹¤.
- ê°ì‚¬ì¡°ê±´(`audit_condition`) êµ¬ë¬¸ì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê°ì‚¬ë˜ëŠ” ê°ì²´ì— ì•¡ì„¸ìŠ¤ë¥¼ í•˜ë©´
    
    **ORA-28112 ì˜¤ë¥˜**ê°€ ë°œìƒí•œë‹¤.
    

```sql
alter system set audit_trail = none scope = spfile; 
-- FGAì— ëŒ€í•´ ë”°ë¡œ í™•ì¸í•´ë³´ê¸° ìœ„í•´ none ìœ¼ë¡œ ì„¸íŒ…í•¨. (test ëª©ì )

SYS@ora19c> shutdown immediate;  -- spfileì´ë‹ˆê¹Œ db shutdowní–ˆë‹¤ ë‹¤ì‹œ startup

Database closed.
Database dismounted.
ORACLE instance shut down.

SYS@ora19c> startup;
ORACLE instance started.

drop table hr.emp purge;

-- í…Œì´ë¸” ìƒì„±
create table hr.emp
as
select employee_id id, last_name name, salary sal, commission_pct comm, department_id dept_id
from hr.employees;

-- sawon01, sawon02 ì—ê²Œ ê°ì²´ ê¶Œí•œì„ ì¤Œ.
grant select, insert, delete, update on hr.emp to sawon01, sawon02;
```

## ðŸ“Œ FGA ìƒì„±

- Oracleì˜ `DBMS_FGA.ADD_POLICY` ëŠ” **ë‚´ìž¥ íŒ¨í‚¤ì§€(DBMS_FGA)** ì•ˆì— ì •ì˜ëœ **í”„ë¡œì‹œì €**.
    - SQLì´ ì•„ë‹Œ PL/SQL ì‹¤í–‰ ë¬¸ì´ê¸° ë•Œë¬¸ì—, ë‹¨ë…ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ì—†ë‹¤. ê·¸ëž˜ì„œ ë°˜ë“œì‹œ ìµëª… ë¸”ë¡ êµ¬ì¡°ë¡œ ê°ì‹¸ì•¼ í•œë‹¤.

**ðŸŒ³ ì •ì±… ìƒì„±**  

```sql
SYS@ora19c>
BEGIN
  dbms_fga.add_policy(
    object_schema   => 'hr',
    object_name     => 'emp',
    policy_name     => 'emp_fga',  -- ì—¬ê¸°ê¹Œì§€ë§Œ ìž‘ì„±í•˜ë©´ ìŠ¤í‚¤ë§ˆ ê°ì‚¬ëž‘ ë‹¤ë¥¼ ê²Œ ì—†ë‹¤.
    audit_condition => 'dept_id = 80', -- NULLì„ í•˜ê±°ë‚˜ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  í–‰ì„ ê°ì‚¬.
    audit_column    => 'sal,comm', -- NULLë¡œ í•˜ê±°ë‚˜ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì—´(ì»¬ëŸ¼)ì„ ê°ì‚¬.
    audit_column_opts => dbms_fga.all_columns,
    statement_types => 'select,insert,update,delete',
    enable => TRUE
  );
END;
/

```

ðŸŒ³ **ì„¤ëª… (ì •ë¦¬)**

```sql

BEGIN
  dbms_fga.add_policy(
    object_schema      => 'hr',                      -- ëŒ€ìƒ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
    object_name        => 'emp',                     -- ê°ì‚¬ í…Œì´ë¸” ì´ë¦„
    policy_name        => 'emp_fga',                 -- ì •ì±… ì´ë¦„
    audit_condition    => 'dept_id = 80',            -- ê°ì‚¬ ì¡°ê±´ (WHERE ì ˆ ì—­í• )
    audit_column       => 'sal,comm',                -- íŠ¹ì • ì»¬ëŸ¼ ì ‘ê·¼ ì‹œ ê°ì‚¬
    audit_column_opts  => dbms_fga.all_columns,      -- ëª¨ë“  ì»¬ëŸ¼ ì¡°ê±´ì— ëŒ€í•´ ê°ì‚¬
    statement_types    => 'select,insert,update,delete', -- ê°ì‚¬í•  ë¬¸ ì¢…ë¥˜
    enable             => TRUE                       -- ì •ì±… í™œì„±í™”
  );
END;
/
```

ðŸ‘‰ `PL/SQL procedure successfully completed.`

### ì°¸ê³ 

- `dbms_fga.all_columns` â†’ ì—´ ì´ë¦„ ëª¨ë‘ ë³¼ ê²½ìš°
- `dbms_fga.any_columns` â†’ ì—´ ì¤‘ ì¼ë¶€ë§Œ ë³¼ ê²½ìš°
- `statement_types` â†’ ê¸°ë³¸ì€ `select`

ðŸŒ³ **í™•ì¸**

```sql

select * from dba_audit_policies;

```

![image.png](/assets/20250710/1.png)

### ðŸ”’ ë¹„í™œì„±í™” í•˜ê³ ìž í•œë‹¤ë©´? (ì‚­ì œx )

```sql
BEGIN
  DBMS_FGA.DISABLE_POLICY(
    object_schema => 'hr',       -- ëŒ€ìƒ ìŠ¤í‚¤ë§ˆ
    object_name   => 'emp',      -- ëŒ€ìƒ í…Œì´ë¸”
    policy_name   => 'emp_fga'   -- ë¹„í™œì„±í™”í•  ì •ì±… ì´ë¦„
  );
END;
/
```

- ë™ì¼ ë‚´ìš©ì— `ENABLE` í•˜ë©´ ì •ì±… í™œì„±í™”
- ë™ì¼ ë‚´ìš©ì— `DROP` í•˜ë©´ ì •ì±… ì‚­ì œ

âž¡ í…ŒìŠ¤íŠ¸ ì‹œìž‘ ì „ì— ì¼ë‹¨ ë‹¤ì‹œ í™œì„±í™”í•´ì£¼ìž.

```sql
BEGIN
  DBMS_FGA.ENABLE_POLICY(
    object_schema => 'hr',
    object_name   => 'emp',
    policy_name   => 'emp_fga'
  );
END;
/
```

```sql
-- â–¶ sawon01 select í…ŒìŠ¤íŠ¸ 
 
SELECT * FROM hr.emp;

SELECT * FROM hr.emp WHERE dept_id = 80;

SELECT * FROM hr.emp WHERE id = 150;
-- 150ë²ˆ ì‚¬ì›ì´ 80ë²ˆ ë¶€ì„œë¼ì„œ ê°ì‚¬í…Œì´ë¸”ì— ê¸°ë¡ë˜ì—ˆìŒ

SELECT id, sal, comm, dept_id FROM hr.emp;

SELECT sal FROM hr.emp WHERE dept_id = 80;
-- ê¸°ë¡ ì•ˆë¨ (ì»¬ëŸ¼ ê°ì‚¬ ì¡°ê±´ ì•ˆ ë§žìŒ)

SELECT id, sal FROM hr.emp
WHERE dept_id = 80 AND comm IS NOT NULL;

-- â–¶ sys session 

SELECT timestamp, object_name, sql_text
FROM DBA_FGA_AUDIT_TRAIL;

```

![image.png](/assets/20250710/2.png)

```sql
-- â–¶ sawon02 insert test
INSERT INTO hr.emp(id, name, sal, comm, dept_id)
VALUES (300, 'zoey', 5000, 0.1, 80);

INSERT INTO hr.emp(id, name, sal, comm, dept_id)
VALUES (400, 'lucy', 4000, 0.3, 20);
-- 20ë²ˆ ë¶€ì„œë¼ ê¸°ë¡ë˜ì§€ ì•ŠìŒ

COMMIT;

--â–¶ sys session

SELECT TO_CHAR(timestamp, 'yyyy-mm-dd hh24:mi:ss') AS time,
       db_user,
       policy_name,
       sql_bind,
       sql_text
FROM dba_fga_audit_trail;
```

---

![image.png](/assets/20250710/3.png)

### ðŸ“Œ ê°ì‚¬ + í”„ë¡œê·¸ëž¨

ê°ì‚¬ ì •ë³´ë„ ë‹´ê³ , ë³„ë„ì˜ í”„ë¡œê·¸ëž¨ì„ ìˆ˜í–‰í•˜ê³ ìž í•œë‹¤.

```sql
-- â–¶ sys session

CREATE TABLE hr.fga_emp_log (
  object_schema VARCHAR2(30),
  object_name   VARCHAR2(30),
  policy_name   VARCHAR2(30),
  user_name     VARCHAR2(20),
  sql_text      VARCHAR2(100),
  day           TIMESTAMP
);

```

```sql
-- í”„ë¡œì‹œì € ìƒì„± 
CREATE OR REPLACE PROCEDURE hr.fga_trail_proc(
  object_schema IN VARCHAR2,
  object_name   IN VARCHAR2,
  policy_name   IN VARCHAR2
)
IS
  PRAGMA AUTONOMOUS_TRANSACTION;  -- !! ë…ë¦½ íŠ¸ëžœìž­ì…˜ ì„ ì–¸ë¶€
BEGIN
  INSERT INTO hr.fga_emp_log(object_schema, object_name, policy_name, user_name, sql_text, day)
  VALUES (
    object_schema,
    object_name,
    policy_name,
    SYS_CONTEXT('USERENV', 'SESSION_USER'),  -- í˜„ìž¬ ì„¸ì…˜ ì‚¬ìš©ìž
    SYS_CONTEXT('USERENV', 'CURRENT_SQL'),   -- ì‹¤í–‰ ì¤‘ì¸ SQLë¬¸
    LOCALTIMESTAMP
  );
  COMMIT;
END fga_trail_proc;
/

```

### ê¸°ì¡´ ì •ì±… ì‚­ì œ

```sql
BEGIN
  DBMS_FGA.DROP_POLICY(
    object_schema => 'hr',
    object_name   => 'emp',
    policy_name   => 'emp_fga'
  );
END;
/
```

### ì •ì±… ë‹¤ì‹œ ì¶”ê°€

```sql

BEGIN
  DBMS_FGA.ADD_POLICY(
    object_schema      => 'hr',
    object_name        => 'emp',
    policy_name        => 'emp_fga',
    audit_condition    => 'dept_id = 80',
    audit_column       => 'sal,comm',
    audit_column_opts  => DBMS_FGA.ALL_COLUMNS,
    statement_types    => 'select,insert,update,delete',
    handler_schema     => 'hr',              -- í•¸ë“¤ëŸ¬ í”„ë¡œì‹œì €ê°€ ìœ„ì¹˜í•œ ìŠ¤í‚¤ë§ˆ
    handler_module     => 'fga_trail_proc',  -- ì¡°ê±´ì´ ë§Œì¡±ëì„ ë•Œ ì‹¤í–‰í•  ì‚¬ìš©ìž ì •ì˜ í”„ë¡œì‹œì €
    enable             => TRUE
  );
END;
/

```

### SYS_CONTEXT í•¨ìˆ˜ í™•ì¸

```sql
SELECT SYS_CONTEXT('USERENV', 'SESSION_USER') FROM dual;
-- í˜„ìž¬ ì ‘ì† ì¤‘ì¸ ì‚¬ìš©ìžì˜ ê³„ì •ëª… (ìŠ¤í‚¤ë§ˆëª…) ë°˜í™˜

SELECT SYS_CONTEXT('USERENV', 'CURRENT_SQL') FROM dual;
-- í˜„ìž¬ ì‹¤í–‰í•œ SQLë¬¸ ë°˜í™˜

```

```sql
-- â–¶ sawon01 

SELECT * FROM hr.emp;

SELECT * FROM hr.emp WHERE dept_id = 80;

SELECT * FROM hr.emp WHERE id = 150;

SELECT id, sal, comm, dept_id FROM hr.emp;

SELECT sal FROM hr.emp WHERE dept_id = 80;

SELECT id, sal FROM hr.emp WHERE dept_id = 80 AND comm IS NOT NULL;

-- â–¶ sys session

SELECT TO_CHAR(timestamp, 'yyyy-mm-dd hh24:mi:ss') AS time,
       db_user,
       policy_name,
       sql_bind,
       sql_text
FROM dba_fga_audit_trail;
```

![image.png](/assets/20250710/4.png)

```sql
-- ðŸ“Œ ë‚´ë¶€ í”„ë¡œì‹œì €ë¡œ ì¸í•´ í•´ë‹¹ í…Œì´ë¸”ì—ë„ ì •ë³´ê°€ ìŒ“ìž„
select * from hr.fga_emp_log;
```

### ðŸ“Œ ê°ì‚¬ ë¡œê·¸ í…Œì´ë¸” ì´ê´€ (AUD$, FGA_LOG$)

- `AUD$`, `FGA_LOG$` ëŠ” ì‹œìŠ¤í…œ í…Œì´ë¸”ìŠ¤íŽ˜ì´ìŠ¤ì— ì¡´ìž¬í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ í…Œì´ë¸”
- ì™œ ì´ê´€?
    1. ë¡œê·¸ëŠ” ê³„ì† ìŒ“ì—¬ì„œ DB ìž¥ì•  ê°€ëŠ¥ì„±
    2. ê´€ë¦¬/ë°±ì—…/ì••ì¶•/ì‚­ì œ ìš©ì´

---

### âœ… í˜„ìž¬ í…Œì´ë¸” ìœ„ì¹˜ í™•ì¸

```sql
SELECT table_name, tablespace_name
FROM dba_tables
WHERE table_name IN ('AUD$', 'FGA_LOG$');
```

![image.png](/assets/20250710/5.png)

### âœ… ìƒˆë¡œìš´ í…Œì´ë¸”ìŠ¤íŽ˜ì´ìŠ¤ ìƒì„± (ì˜ˆ: audit_aux)

```sql
CREATE TABLESPACE audit_aux
DATAFILE '/u01/app/oracle/oradata/ORA19C/audit_aux01.dbf' SIZE 10M AUTOEXTEND ON NEXT 1M
EXTENT MANAGEMENT LOCAL UNIFORM SIZE 1M
SEGMENT SPACE MANAGEMENT AUTO;
```

### âœ… ê°ì‚¬ í…Œì´ë¸”ì˜ í…Œì´ë¸”ìŠ¤íŽ˜ì´ìŠ¤ ë³€ê²½ (ë…¼ë¦¬ì  ë³€ê²½)

```sql
BEGIN
  dbms_audit_mgmt.set_audit_trail_location(
    audit_trail_type => dbms_audit_mgmt.audit_trail_aud_std,
    audit_trail_location_value => 'audit_aux'
  );
END;
/
```

- `AUD$` ëŒ€ìƒ
- FGA ë¡œê·¸ëŠ” `audit_trail_fga_std` ë¡œ ì§€ì •

---

### âœ… ë³€ê²½ ê²°ê³¼ í™•ì¸

```sql
SELECT table_name, tablespace_name
FROM dba_tables
WHERE table_name IN ('AUD$', 'FGA_LOG$');
```

- â†’ ì—¬ì „ížˆ ë°ì´í„°ëŠ” ê¸°ì¡´ì— ìžˆìŒ â†’ **ë°ì´í„° ì´ë™ í•„ìš”**

![image.png](/assets/20250710/6.png)

### âœ… ì›ìœ„ì¹˜ ë³µêµ¬ (ì‹œìŠ¤í…œ í…Œì´ë¸”ìŠ¤íŽ˜ì´ìŠ¤ë¡œ)

```sql
BEGIN
  dbms_audit_mgmt.set_audit_trail_location(
    audit_trail_type => dbms_audit_mgmt.audit_trail_aud_std,
    audit_trail_location_value => 'system'
  );
END;
/

BEGIN
  dbms_audit_mgmt.set_audit_trail_location(
    audit_trail_type => dbms_audit_mgmt.audit_trail_fga_std,
    audit_trail_location_value => 'system'
  );
END;
/

SELECT table_name, tablespace_name
FROM dba_tables
WHERE table_name IN ('AUD$', 'FGA_LOG$');

```

---

### âœ… í…ŒìŠ¤íŠ¸ìš© TBS ì‚­ì œ

```sql
DROP TABLESPACE audit_aux INCLUDING CONTENTS AND DATAFILES;
```