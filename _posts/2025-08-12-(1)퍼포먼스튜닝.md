---
title: "[76ì¼ì°¨] í¼í¬ë¨¼ìŠ¤ íŠœë‹ "
excerpt: "ì•„ì´í‹°ìœŒ 0812_(1)"
categories:
      - ORACLE19c
tags:
      - ORACLE19c
      - TIL
last-modified-at: 2025-08-12T21:08
---

# í¼í¬ë¨¼ìŠ¤ íŠœë‹

ğŸ“ **shared pool latch**

- hard parsing ì´ ë°œìƒí•˜ëŠ” ê²½ìš° í”„ë¦¬ ì²­í¬ë¥¼ ì°¾ê¸° ìœ„í•´ free listë¥¼ íƒìƒ‰í•˜ê³  ì ì ˆí•œ chunkë¥¼ í• ë‹¹í•˜ê³  í•„ìš”í•œ ê²½ìš° í”„ë¦¬ ì²­í¬ë¥¼ ë¶„í• (split)í•˜ëŠ” ì¼ë ¨ì˜ ì‘ì—…ë“¤ì€ ëª¨ë‘ shared pool latchë¥¼ íšë“í•œ í›„ì—ë§Œ ê°€ëŠ¥í•˜ë‹¤. shared pool latchë¥¼ íšë“í•˜ëŠ” ê³¼ì •ì—ì„œ ê²½í•©ì´ ë°œìƒí•˜ë©´ latch: shared pool ì´ë²¤íŠ¸ë¥¼ ëŒ€ê¸°í•œë‹¤.
- shared pool latchëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ì— í•˜ë‚˜ë§Œ ì¡´ì¬í•œë‹¤.
- 9i ë²„ì „ë¶€í„°ëŠ” shared pool ì„ ì—¬ëŸ¬ ê°œì˜ ì„œë¸Œ í’€ë¡œ ìµœëŒ€ 7ê°œê¹Œì§€ ë‚˜ëˆ„ì–´ì„œ ê´€ë¦¬í•˜ë©° ì˜¤ë¼í´ì€ cpu ê°œìˆ˜ê°€ 4ê°œ ì´ìƒì´ê³  shared poolì˜ í¬ê¸°ê°€ 250m ì´ìƒì¸ ê²½ìš° *kghdsidx_count íŒŒë¼ë¯¸í„° ê°’ë§Œí¼ ì„œë¸Œ í’€ì„ ìƒì„±í•´ì„œ ê´€ë¦¬í•œë‹¤.*
- ê° ì„œë¸Œí’€ë§ˆë‹¤ latchê°€ ë§Œë“¤ì–´ì§€ê¸° ë•Œë¬¸ì— shared pool latchì˜ ê²½í•©ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

```sql
SYS@ora19c> select a.ksppinm parameter, b.ksppstvl value
from x$ksppi a, x$ksppcv b
where a.indx = b.indx
and a.ksppinm = '_kghdsidx_count';
```

![image.png](/assets/20250812/1.png)

```sql
select name, gets from v$latch_children where name = 'shared pool';
-- v$ ~ : dbê°€ ë‚´ë ¤ê°”ë‹¤ ì˜¬ë¼ì˜¬ ë•Œë¶€í„° ëˆ„ì ëœ ë°ì´í„° ë³´ì—¬ì¤€ë‹¤.
```

![image.png](/assets/20250812/2.png)

```sql
show parameter cpu_count

/*

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
cpu_count                            integer     2

*/
```

ğŸ“version count

- ìì‹ LCO (Library Cache Object) ìˆ˜
- ë²„ì „ ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•˜ëŠ” ê²½ìš°ëŠ” 53ê°€ì§€ê°€ ìˆë‹¤. v$sql_shared_cursor;

```sql
-- Yë¥¼ ì°¾ì•„ë¼
select * from v$sql_shared_cursor;
```

![image.png](/assets/20250812/3.png)

```sql
alter system flush shared_pool; 

-- â–¶ï¸ hr ì„¸ì…˜
var name varchar2(10)
execute :name := 'King'
print name 

/*
NAME
--------------------------------
King
*/

select last_name, salary from hr.employees where last_name = :name;

-- ë˜‘ê°™ì€ ì„¸ì…˜ì—ì„œ bind ë³€ìˆ˜ ë˜‘ê°™ì´. í¬ê¸°ëŠ” ë‹¤ë¥´ê²Œ -> ì´ë ‡ê²Œ í•˜ë©´ ì•ˆë¨.
var name varchar2(1000) -- í•˜ë‚˜ì˜ ì„¸ì…˜ì—ì„œ bind ë³€ìˆ˜ë¥¼ ë‹¤ì‹œ ì„ ì–¸í•˜ë©´ ì•ˆëœë‹¤.
execute :name := 'King'
print name

select last_name, salary from hr.employees where last_name = :name;

select sql_id, sql_text, version_count
from v$sqlarea
where sql_text like '%hr.employees%'
and sql_text not like '%v$sqlarea%';
-- version_count 2 (child table) ê°œë”ë¼ë„ main tableê¹Œì§€ ê³ ë ¤í•˜ë©´ 3ì´ë‹¤.
```

![image.png](/assets/20250812/4.png)

```sql
select * from v$sql_shared_cursor where sql_id = 'gqgwd5rvu5ftu';
```

```sql
select address, child_address, child_number, bind_length_upgradeable from v$sql_shared_cursor where sql_id = 'gqgwd5rvu5ftu'
```

![image.png](/assets/20250812/5.png)

```sql
select address, child_address, child_number, datatype_string, max_length, value_string
from v$sql_bind_capture
where sql_id = 'gqgwd5rvu5ftu';
```

![image.png](/assets/20250812/6.png)

ğŸ“ varchar2 size(32, 128, 2000, 4000) 4ê°€ì§€ í¬ê¸°ë¡œ ê²°ì •ëœë‹¤.

```sql
select * from table(dbms_xplan.display_cursor('gqgwd5rvu5ftu', 0));
select * from table(dbms_xplan.display_cursor('gqgwd5rvu5ftu', 1));

/*
---------------------------------------------------------------------------------------------------
| Id  | Operation                           | Name        | Rows  | Bytes | Cost (%CPU)| Time     |
---------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                    |             |       |       |     2 (100)|          |
|   1 |  TABLE ACCESS BY INDEX ROWID BATCHED| EMPLOYEES   |     1 |    12 |     2   (0)| 00:00:01 |
|*  2 |   INDEX RANGE SCAN                  | EMP_NAME_IX |     1 |       |     1   (0)| 00:00:01 |
---------------------------------------------------------------------------------------------------

*/

-- â–¶ï¸ ì—­ìœ¼ë¡œ ì²˜ìŒë¶€í„° í° ê°’ì„ ì ìš©í•˜ë‹¤, ì‘ì€ ê°’ìœ¼ë¡œ ë³€ê²½ -> sharing í•˜ì§€ ì•ŠìŒ. 
```

ğŸ“ íŠ¹ì • cursorë¥¼ purge (11g)

```sql
select sql_id, sql_text, version_count ,address, hash_value
from v$sqlarea
where sql_text like '%hr.employees%'
and sql_text not like '%v$sqlarea%';
                                -- address        --hash value    
 execute dbms_shared_pool.purge('0000000063C6CF88,4154637114','c')
```

Purgeí•  ê°ì²´ íƒ€ì…

- `'c'` : ì»¤ì„œ(cursor)
- `'p'` : PL/SQL íŒ¨í‚¤ì§€
- `'r'` : í”„ë¡œì‹œì €(procedure)
- `'t'` : íŠ¸ë¦¬ê±°(trigger)
- `'q'` : ì‹œí€€ìŠ¤(sequence)
- `'f'` : í•¨ìˆ˜(function)

ğŸ“ **ê³¼ë„í•œ hard parsing ë¬¸ì œì **

- ì‹¤í–‰ ê³„íš ìƒì„±ì‹œì— ê³¼ë‹¤í•œ CPU, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
- library cache chainì˜ í™•ì¥ìœ¼ë¡œ ì¸í•œ ê²€ìƒ‰ì‹œê°„ ì¦ê°€, mutex ì ìœ  ì‹œê°„ ì¦ê°€
- shared pool fragmentation(ë‹¨í¸í™”) : chunkê°€ ì‘ì€ í¬ê¸°ë¡œ ìª¼ê°œì ¸ì„œ chunk ìˆ˜ê°€ ì¦ê°€í•˜ëŠ” í˜„ìƒ, ë”°ë¼ì„œ ì²´ì¸ì˜ ê¸¸ì´ë¥¼ ì¦ê°€ì‹œì¼œ ì²´ì¸ ê²€ìƒ‰ ì†ë„ ì €í•˜ ìœ ë°œ, í•˜ë“œ íŒŒì‹±ì‹œ í•„ìš”í•œ ì²­í¬ ì°¾ì§€ ëª»í•˜ëŠ” ë¬¸ì œ ë°œìƒ (ORA-4031) í™•ë¥ ì´ ë†’ì•„ ì§„ë‹¤.

ğŸ“ **row cache lock**

- data dictionary cache (row cache) ëŠ” ì˜¤ë¼í´ ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ì •ë³´ì— ëŒ€í•œ cache ì˜ì—­
- ìœ ì €, ê°ì²´, í…Œì´ë¸”, ì„¸ê·¸ë¨¼íŠ¸, ì»¬ëŸ¼, ì¸ë±ìŠ¤, ì‹œí€€ìŠ¤, ë·°, í•¨ìˆ˜, í”„ë¡œì‹œì €, íŒ¨í‚¤ì§€, íŠ¸ë¦¬ê±°,â€¦
- DDL ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´ ë”•ì…”ë„ˆë¦¬ ì •ë³´ì— ëŒ€í•œ ì…ë ¥, ìˆ˜ì •, ì‚­ì œ
- semantic ì²´í¬ì‹œì— ë”•ì…”ë„ˆë¦¬ ì •ë³´ë¥¼ ì´ìš©í•´ì„œ ì²´í¬í•œë‹¤.
- row cache lockì€ dictionary objectë¥¼ ë³´í˜¸í•˜ëŠ” ì‹œìŠ¤í…œ lockì´ë‹¤.

```sql
select pool, name, bytes from v$sgastat where name = 'row cache';
select cache#, type, parameter from v$rowcache;

/*
  CACHE# TYPE        PARAMETER
---------- ----------- --------------------------------
        13 PARENT      **dc_sequences**     <<- low cache lockì´ë¼ëŠ” ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚œë‹¤.
        16 PARENT      dc_histogram_defs
        54 PARENT      dc_sql_prs_errors
        32 PARENT      kqlsubheap_object
        19 PARENT      dc_table_scns
        18 PARENT      dc_outlines
        15 PARENT      dc_props
        60 PARENT      dc_cdbprops
        14 PARENT      dc_profiles
        47 PARENT      realm cache
        48 PARENT      Command rule cache
*/

-- â–¶ï¸ hr session
create sequence hr.seq_1 nocache;

-- ì •ë³´ í™•ì¸
select * from dba_sequences where sequence_owner = 'HR' and sequence_name = 'SEQ_1';

-- sess_1
exec dbms_application_info.set_client_info('sess_1')

declare
		v_value number;
begin
		for i in 1.. 100000 loop
			select hr.seq_1.nextval into v_value from dual;
		end loop;
end;
/

select hr.seq_1.nextval from dual;

-- sess_2 
exec dbms_application_info.set_client_info('sess_2')

declare
		v_value number;
begin
		for i in 1.. 100000 loop
			select hr.seq_1.nextval into v_value from dual;
		end loop;
end;
/

-- sys
select sid, event, wait_class, wait_time, seconds_in_wait, state from v$session where client_info in ('sess_1', 'sess_2');

select h.address, h.saddr, s.sid, h.lock_mode from v$rowcache_parent h, v$rowcache_parent w, v$session s where h.address = w.address and w.saddr = (select saddr from v$session where event = 'row cache lock' and rownum = 1) and h.saddr = s.saddr and h.lock_mode > 0;
```

â–¶ï¸

```sql
select prev_sql_addr from v$session where sid = sid ì´ë¦„

select * from dba_sequences where sequence_owner = 'HR' and sequence_name = 'SEQ_1';
```

â–¶ï¸ row cache lock ê²½í•© ì¤‘ì— sequence nocache ì†ì„±ìœ¼ë¡œ ì¸í•´ ë§ì´ ë°œìƒí•œë‹¤.

- nextval ìˆ˜í–‰í•  ë•Œë§ˆë‹¤ ë”•ì…”ë„ˆë¦¬ ì •ë³´ë¥¼ ë³€ê²½í•˜ê¸° ìœ„í•´ì„œ ssx(shared sub exclusive 5) ëª¨ë“œë¥¼ íšë“í•´ì•¼ í•¨ìœ¼ë¡œ ê²½í•©ì´ ë°œìƒí•œë‹¤.
- í•´ê²° ë°©ë²•
    - cache ì†ì„±ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ í•œë‹¤.
    
    ```sql
    alter sequence hr.seq_1 cache 100;
    ```
    

â–¶ï¸ cache size 20 , 100 ë¹„êµ 

![image.png](/assets/20250812/7.png)

**20** â†’ ì´ëŸ° wait event ë°œìƒ

ğŸ“ enq : SQ - contention : cache í¬ê¸°ê°€ ì‘ê²Œ ìƒì„±ëœ ê²½ìš°

**100** â†’ ì´ë²¤íŠ¸ ë°œìƒí•˜ì§€ ì•ŠìŒ

â–¶ï¸ ë§Œì•½, 100ì—ì„œë„ ë°œìƒí•œë‹¤?

ğŸŒ³ shared pool (LRU ì•Œê³ ë¦¬ì¦˜ : ê°€ì¥ ìµœê·¼ê¹Œì§€ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°ì´í„° ì—…ë°ì´íŠ¸)

ğŸ“Database Buffer Cache (Data Buffer Cache)

- ì˜¤ë¼í´ì€ ë¬¼ë¦¬ì ì¸ I/O ë¥¼ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ìµœê·¼ì— ì‚¬ìš©ëœ ë¸”ë¡ì„ ë©”ëª¨ë¦¬ì˜ ì¼ì • ì˜ì—­ì— ë³´ê´€í•œë‹¤. ì´ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ë°ì´í„° ë²„í¼ ìºì‹œë¼ê³  í•œë‹¤.

```sql
select * from hr.employees where employee_id = 100;
```

1ï¸âƒ£ parse

2ï¸âƒ£ bind

3ï¸âƒ£ execute

- library cache lock ê³¼ library cache pinì„ shared ëª¨ë“œë¡œ ë³€í™˜í•œë‹¤.
- ì‹¤í–‰ ê³„íšì„ ì´ìš©í•´ì„œ BLOCK I/O ë°œìƒ
    - ìš”ì²­í•œ ë¸”ë¡ì˜ DBA (Data Block Address) ì™€ Block class (ë¸”ë¡ ì¢…ë¥˜) ì— ëŒ€í•´ í•´ì‹œ í•¨ìˆ˜ë¥¼ ì ìš©í•œ ê²°ê³¼ë¥¼ ì´ìš©í•´ì„œ hash bucketì„ ì°¾ëŠ”ë‹¤.
    - hash bucket ê°™ì€ í•´ì‹œ ê°’ì„ ê°–ëŠ” ë²„í¼ í—¤ë” (buffer header) ë“¤ì´ ì²´ì¸(chain) í˜•íƒœë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤.
    - ë²„í¼ í—¤ë” (buffer header)ëŠ” ë²„í¼ì— ë©”íƒ€ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ë²„í¼ ë©”ëª¨ë¦¬ ì˜ì—­ì˜ ì‹¤ì œ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆë‹¤.
    - hash bucket ì€ shared poolì—ì„œ ê´€ë¦¬í•œë‹¤.
    - í•´ì‹œê°’ì— í•´ë‹¹í•˜ëŠ” hash bucketì„ ê²€ìƒ‰í•˜ê¸° ìœ„í•´ì„œëŠ” latch íšë“í•´ì•¼ í•œë‹¤. ì´ë•Œ latchì— ê²½í•©ì´ ë°œìƒí•  ê²½ìš° latch: cache buffers chains ì´ë²¤íŠ¸ ë°œìƒí•œë‹¤.

```sql
select count(*) from v$latch_children where name = 'cache buffers chains';
```

![image.png](/assets/20250812/8.png)

```sql
select a.ksppinm parameter, b.ksppstvl value
from x$ksppi a, x$ksppcv b
where a.indx = b.indx
and a.ksppinm = '_db_block_hash_latches';

-- _db_block_hash_latches	1024
```

â–¶ï¸ hash bucket ìˆ˜

```sql
 select a.ksppinm parameter, b.ksppstvl value
from x$ksppi a, x$ksppcv b
where a.indx = b.indx
and a.ksppinm = '_db_block_hash_buckets';

-- _db_block_hash_buckets	32768
```

â–¶ï¸ í•˜ë‚˜ì˜ latchê°€ ë‹´ë‹¹í•˜ëŠ” bucket ìˆ˜  : 131072/1024 = 128

ğŸ“ hash bucketì„ ë³´í˜¸í•˜ëŠ” cache buffers chains latch

- ì½ê¸° ì‘ì—… : shared mode
- ì“°ê¸° ì‘ì—… : exclusive mode

ì´ ê³¼ì •ì—ì„œ ê²½í•©ì´ ë°œìƒí•˜ë©´ latch : cache buffers chains ì´ë²¤íŠ¸ê°€ ë°œìƒí•œë‹¤.

ğŸ“ ë…¼ë¦¬ì (logical) I/O (ì´ ì½ì–´ë“¤ì¸ ë¸”ë¡ì˜ ìˆ˜)  - accessí•œ ë¸”ë¡ì˜ ìˆ˜ (ex. 4) 

- ë¸”ë¡ I/O (**ë¬¼ë¦¬ì  I/O í¬í•¨**)

ğŸ“ ë¬¼ë¦¬ì (physical) I/O  (ë¸”ë¡ I/O)  (ex.1) : ë©”ëª¨ë¦¬ì— ì—†ì–´ ë””ìŠ¤í¬ì—ì„œ ì˜¬ë¦° ìˆ˜ 

- accessí•˜ë ¤ëŠ” ë¸”ë¡ì´ ë©”ëª¨ë¦¬ì— ì—†ì„ ê²½ìš°

â–¶ï¸ ì´ ì½ì–´ë“¤ì¸ ë¸”ë¡ì˜ ìˆ˜ 4

â–¶ï¸ í•˜ë“œ íŒŒì‹±ê³¼ ë¬¼ë¦¬ì  I/Oì™€ëŠ” ë³„ê°œì´ë‹¤.