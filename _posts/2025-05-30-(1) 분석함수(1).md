---
title: "[29ì¼ì°¨] ë¶„ì„í•¨ìˆ˜(2)"
excerpt: "ì•„ì´í‹°ìœŒ 0530_(1) first_value, last_value, ê¸°íƒ€ ì˜µì…˜ë“¤ "
categories:
      - ORACLE11g
tags:
      - ORACLE11g
      - TIL
last-modified-at: 2025-05-30T20:10
---

# ë¶„ì„í•¨ìˆ˜(2)

## first_value

**ì •ë ¬ëœ ê°’**ë“¤ ì¤‘ **ì²«ë²ˆì§¸ ê°’ì„ ë¦¬í„´**í•˜ëŠ” í•¨ìˆ˜

```sql
SELECT
		employee_id,
		salary,
		department_id,
		first_value(salary) over(order by salary)
FROM hr.employees;		
```

![image.png](/assets/20250530/1.png)

â¡ salary ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ê³  ì²«ë²ˆì§¸ ê°’ì¸ 2100ì„  ì‚¬ì› ìˆ˜(107 row) aë§Œí¼ í”„ë¦°íŠ¸í•¨.

ğŸŒ¿ **ì˜¤ë¦„ì°¨ìˆœ**

```sql
SELECT
		employee_id,
		salary,
		department_id,
		first_value(salary) over(order by salary) first_sal_1,
        first_value(salary) over(partition by department_id order by salary) first_sal_2
FROM hr.employees
ORDER BY department_id;
```

![image.png](/assets/20250530/2.png)

ğŸŒ¿ **ë‚´ë¦¼ì°¨ìˆœ**

```sql
SELECT
		employee_id,
		salary,
		department_id,
		first_value(salary) over(order by salary desc) first_sal_1,
    first_value(salary) over(partition by department_id order by salary desc) first_sal_2
FROM hr.employees
ORDER BY department_id;	

```

![image.png](/assets/20250530/3.png)

ğŸŒ¿ **min() over()** 

â¡ ê·¸ë£¹ í•¨ìˆ˜ min() ë’¤ì— over() ìœ ë¬´ì— ë”°ë¥¸ ë¹„êµ ( **min() VS min() over()**)

ğŸ“Œ **over() (ìœˆë„ìš° í•¨ìˆ˜ : í–‰ê³¼ í–‰ê°„ì˜ ê´€ê³„ë¥¼ ì •ì˜í•˜ëŠ” í•¨ìˆ˜) ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°**

```sql
----(1)
-- ê°€ëŠ¥ 
-- ì „ì²´ í…Œì´ë¸”ì—ì„œ ê°€ì¥ ë‚®ì€ ê¸‰ì—¬ í•œ ê°œë§Œ ì¶”ì¶œ
-- **ë‹¨ì¼ ê°’** ë°˜í™˜ (ê·¸ë£¹ í•¨ìˆ˜: ì—¬ëŸ¬ í–‰ ë‹¹ í•˜ë‚˜ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜)

SELECT min(salary)
FROM hr.employees;    

/*

MIN(SALARY)
-----------
2100

*/ 

----(2)
-- ë¶ˆê°€ëŠ¥. ì˜¤ë¥˜ë‚¨ 
-- ORA-00937: not a single-group group function (ë‹¨ì¼ ê·¸ë£¹ì˜ ê·¸ë£¹ í•¨ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤.)
-- employee_idëŠ” ì¼ë°˜ ì»¬ëŸ¼ì´ë¯€ë¡œ ê·¸ë£¹ í•¨ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ë ¤ë©´ GROUP BYê°€ í•„ìš”.

SELECT employee_id,
			 min(salary)
FROM hr.employees; 

----(3)
-- ê°€ëŠ¥. ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì—ˆê¸° ë•Œë¬¸.		
-- department_id ë³„ë¡œ ê·¸ë£¹ì„ ë‚˜ëˆ„ê³  ê° ë¶€ì„œ ë‚´ ìµœì € ê¸‰ì—¬ë¥¼ ì°¾ìŒ.

SELECT department_id,
			 min(salary)
FROM hr.employees
GROUP BY department_id;   	 			 
```

ğŸ“Œ **over() ì‚¬ìš©í•˜ëŠ” ê²½ìš°**

- ì›ë˜ì˜ í–‰ ìˆ˜ë¥¼ **ë³€í˜•í•˜ì§€ ì•ŠìŒ**
- ì£¼ì–´ì§„ ì°½(window) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•¨

```sql
-- over() ì—†ì—ˆë‹¤ë©´, ì˜¤ë¥˜ 
-- ìœˆë„ìš° í•¨ìˆ˜ ë’¤ì— ë¶™ì—¬ ëŒ€ìƒì„ 
SELECT
		employee_id,
		salary,
		department_id,
    min(salary) over() min_sal_1,  -- ì „ì²´ salary ê¸°ì¤€ ìµœì € ê¸‰ì—¬ 
    min(salary) over(partition by department_id) min_sal_2 -- ë¶€ì„œë³„
FROM hr.employees
ORDER BY department_id;	
```

ğŸŒ¿ **max() over()**

```sql
SELECT
		employee_id,
		salary,
		department_id,
        max(salary) over() max_sal_1,
        max(salary) over(partition by department_id) max_sal_2
FROM hr.employees
ORDER BY department_id;
```

## last_value

- **ì •ë ¬ëœ ê°’**ë“¤ ì¤‘ **ë§ˆì§€ë§‰ ê°’**ì„ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜

```sql
SELECT
		employee_id,
		salary,
		department_id,
		last_value(salary) over(order by salary) last_sal_1,
		last_value(salary) over(partition by department_id order by salary) last_sal
FROM hr.employees
ORDER BY department_id;		
```

## over() ì˜ order by ì˜ ì˜µì…˜

**â€» ì•„ë˜ì˜ ì˜µì…˜ë“¤ì€ ë°˜ë“œì‹œ order by ë‘ ê°™ì´ ì“¸ ê²ƒ . ê·¸ëƒ¥ over() ì— ì‚¬ìš©í•˜ë©´ ì˜¤ë¥˜ë‚œë‹¤.**

(ORA-30485: missing ORDER BY expression in the window specification)

**ğŸŒ³ rows : í˜„ì¬ row ìœ„ì¹˜ì—ì„œ ë¬¼ë¦¬ì ì¸ ë°©í–¥**

â–¶ï¸ **rows between unbounded preceding and current row** ì˜µì…˜

: ì •ë ¬ ê²°ê³¼ ì²˜ìŒë¶€í„° **í˜„ì¬ í–‰**ê¹Œì§€ë¥¼ ëŒ€ìƒ  

### **ğŸ“Œ í˜„ì¬ í–‰: ì •í™•íˆ ì–´ëŠ í–‰?**

> ğŸ‘‰ ì§€ê¸ˆ **ê³„ì‚° ì¤‘ì¸ ê·¸ í–‰ :** 
Oracleì´ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•ŒëŠ”, ì¿¼ë¦¬ ê²°ê³¼ì˜ ê° í–‰ì„ **í•˜ë‚˜ì”© ìˆœì„œëŒ€ë¡œ ë³´ë©´ì„œ** ë¶„ì„ í•¨ìˆ˜ë¥¼ ì ìš©
> 

â–¶ï¸ **rows between unbounded preceding and unbounded following** ì˜µì…˜

: ì •ë ¬ ê²°ê³¼ì˜ ì²˜ìŒë¶€í„° ëì„ ëŒ€ìƒ  

â–¶ï¸ **rows between 1 preceding and 1 following**

: ì°½ì˜ ë²”ìœ„ë¥¼ **ë”± ì„¸ ì¤„ë¡œ í•œì •**

  í˜„ì¬ í–‰ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ì „ í–‰ê³¼ ë‹¤ìŒ í–‰ê¹Œì§€ ì´ ì„¸ ì¤„ì´ ëŒ€ìƒ 

â–¶ï¸ **rows between current row and current row**

: ê°€ì¥ ì¢ì€ ë²”ìœ„.

**ì§€ê¸ˆ ì´ í–‰ ë”± í•˜ë‚˜ë§Œ** ì´ë¼ëŠ” ëœ».

### ğŸ“Œ **rows between current row and current rowëŠ” ì–´ë–¤ ìƒí™©ì— ì“°ëŠ” ê²ƒ?**

> **ë¹„êµ ê¸°ì¤€ì„ ê³ ì •í•˜ë ¤ê³  í•  ë•Œ**
> 

> **ì´ì „/ë‹¤ìŒ í–‰ë“¤ê³¼ì˜ ì°¨ì´ë¥¼ êµ¬í•  ë•Œ ê¸°ì¤€ í–‰ë§Œ ë¶„ë¦¬í•  ë•Œ**
> 

> **ì¡°ê±´ë¶€ ëˆ„ì í•© ê³„ì‚°ì—ì„œ ì°½ì„ ìµœì†Œí™”í•˜ê³  ì‹¶ì„ ë•Œ**
> 

---

**ğŸ“Œ rows ì˜µì…˜ ì˜ˆì‹œ 1**

```sql
SELECT
    employee_id,
    salary,
    sum(salary) over(order by employee_id) ëˆ„ì í•©,
    sum(salary) over(order by employee_id rows between unbounded preceding and current row) í˜„ì¬í–‰ê¹Œì§€sum,
    sum(salary) over() ì „ì²´í•©,
    sum(salary) over(order by employee_id rows between unbounded preceding and unbounded following) ì²˜ìŒë¶€í„°ëê¹Œì§€sum
FROM hr.employees; 
```

![image.png](/assets/20250530/4.png)

**ê²°ê³¼ê°’ì´ ì™œ ë™ì¼í•˜ê²Œ ë‚˜ì™”ëŠ”ê°€?**

| êµ¬ë¬¸ | ê¸°ë³¸ í”„ë ˆì„ | ìš”ì•½ ì„¤ëª… |
| --- | --- | --- |
| `OVER()` | ì „ì²´ | ì§‘ê³„ì²˜ëŸ¼ ì „ì²´ ë°ì´í„° ê³„ì‚° |
| `OVER(ORDER BY col)` | âœ… `RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW` | **ê¸°ë³¸ê°’** (ëˆ„ì í•©ì²˜ëŸ¼ ë™ì‘) |
| `OVER(ORDER BY col ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)` | âŒ ê¸°ë³¸ê°’ ì•„ë‹˜ | ROW ë‹¨ìœ„ ëˆ„ì  ê³„ì‚°ì„ í•˜ë ¤ë©´ **ëª…ì‹œí•´ì•¼ í•¨** |

**ğŸ“Œ rows ì˜µì…˜ ì˜ˆì‹œ 2**

**í…Œì´ë¸” í•˜ë‚˜ ìƒì„± í›„ í…ŒìŠ¤íŠ¸**

```sql
-- í…Œì´ë¸” ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°
CREATE TABLE na_holo_test(
 e_id number(6),
 name varchar2(10),
 salary number(5),
 dept_id number(4)
)
TABLESPACE users;

-- ì˜ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ í™•ì¸
desc na_holo_test;

SELECT * 
FROM hr.na_holo_test;

-- ë³µìŠµ ê²¸ ì‹œí€€ìŠ¤ ë§Œë“¤ì–´ë³´ê¸°
DROP SEQUENCE test_seq; 

CREATE SEQUENCE test_seq;

-- ë°ì´í„° ì§‘ì–´ë„£ê¸°
INSERT INTO hr.na_holo_test(e_id,name,salary,dept_id) VALUES(test_seq.nextval,'john',10000,10);
INSERT INTO hr.na_holo_test(e_id,name,salary,dept_id) VALUES(test_seq.nextval,'martin',10000,20);
INSERT INTO hr.na_holo_test(e_id,name,salary,dept_id) VALUES(test_seq.nextval,'sally',20000,20);
INSERT INTO hr.na_holo_test(e_id,name,salary,dept_id) VALUES(test_seq.nextval,'alice',15000,30);

SELECT * FROM na_holo_test;

COMMIT;
```

![image.png](/assets/20250530/5.png)

```sql
SELECT
    name,
    dept_id,
    salary,
    sum(salary) over(order by dept_id) "dept_idìˆœì„œëŒ€ë¡œsum",
    sum(salary) over(order by dept_id rows between unbounded preceding and current row) ì˜µì…˜ì ìš©í•© 
FROM hr.na_holo_test;
```

![image.png](/assets/20250530/6.png)

**ğŸŒ³ range : í˜„ì¬ row ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ë…¼ë¦¬ì ì¸ ë²”ìœ„**

```sql
-- ì‚¬ì›ë“¤ì˜ ì…ì‚¬ ì¼ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ 3ê°œì›” ì „ í›„ ê±´ìˆ˜ë¥¼ êµ¬í•˜ì.
SELECT 
		employee_id,
		to_char(hire_date, 'yyyy-mm-dd'),
		hire_date - to_yminterval('00-03') interval_1,
		hire_date - to_yminterval('00-03') interval_2,
		count(*) over(order by hire_date range between interval '3' month preceding and interval '3' month following) cnt
FROM hr.employees;		
```

```sql
-- to_yminterval 00ë…„ 01ê°œì›”
-- ë°‘ì— ë¬¸ì¥ ì˜¤ë¥˜
-- ì¼ìˆ˜ ì •í™•íˆ í•˜ë˜ê°€ -> add_months ì´ìš©í•˜ê¸°
SELECT 
		employee_id,
		to_char(hire_date, 'yyyy-mm-dd'),
		hire_date - to_yminterval('00-01') interval_1,
		hire_date - to_yminterval('00-01') interval_2,
		count(*) over(order by hire_date range between interval '1' month preceding and interval '1' month following) cnt
FROM hr.employees;

-- 2025ë…„ 5ì›” 31ì¼ ì— 1ê°œì›” ë”í•˜ë©´ 2025ë…„ 6ì›” 31ì¼ì¸ë° 6ì›”ì€ 31ì¼ ì—†ë‹¤.
SELECT
    to_date('2025-05-31', 'yyyy-mm-dd') + to_yminterval('00-01')
FROM dual; 

SELECT
    add_months(to_date('2025-05-31', 'yyyy-mm-dd'),1)
FROM dual;

-----> ì´ë ‡ê²Œ ìˆ˜ì •í•˜ì.
SELECT
	employee_id,
	to_char(hire_date, 'yyyy-mm-dd'),
	add_months(hire_date,-1) interval_1,
	add_months(hire_date, 1) interval_2,
	count(*) over(order by hire_date range between interval '1' month preceding and interval '1' month following) cnt
FROM hr.employees;	

SELECT
    to_date('2025-05-31', 'yyyy-mm-dd') + interval '3' month
FROM dual;

SELECT
    to_date('2025-05-31', 'yyyy-mm-dd') + interval '3' year
FROM dual;
```

## NTILE()

- ì •ë ¬í•œ í›„ ì§€ì •í•œ ê°œìˆ˜ì˜ ë“±ê¸‰ìœ¼ë¡œ ë‚˜ëˆˆ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ë‹¤.

```sql
-- ì‚¬ì›ìˆ˜ 107ëª… 
-- 107 /4  = (26*4) +3 ì´ë‹ˆ 26+1, 26+1, 26+1, 26ì”© ê°ê° 1, 2, 3, 4 ë¶€ì—¬.
SELECT
		employee_id,
		salary,
		ntile(4) over(order by salary desc) grade
FROM hr.employees
ORDER BY salary desc;		
```

## LISTAGG()

- íŠ¹ì • ì»¬ëŸ¼ì˜ ê°’ë“¤ì„ ê°€ë¡œë¡œ ì—°ê²°í•´ì„œ í‘œì‹œí•´ì¤€ë‹¤.

```sql
SELECT
	listagg(last_name,',') within group (order by last_name) name
FROM hr.employees;
```

![image.png](/assets/20250530/7.png)

```sql
SELECT
	department_id,
	listagg(last_name,',') within group (order by last_name) name
FROM hr.employees
GROUP BY department_id
```

![image.png](/assets/20250530/8.png)

```sql
SELECT
    employee_id,
    last_name,
	department_id,
	listagg(last_name,',') within group (order by last_name) over(partition by department_id) name
FROM hr.employees;
```

## extract

- ë‚ ì§œí˜•ì„ ìˆ«ìí˜•ìœ¼ë¡œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜

```sql
SELECT
		hire_date,
		to_char(hire_date, 'yyyy') year1,
		extract(year from hire_date) year2
FROM hr.employees;

SELECT
		to_number(to_char(sysdate, 'yyyy')) year1,
		extract(year from sysdate) year2
FROM dual;	

SELECT
		extract(year from sysdate) ë…„,
		extract(month from sysdate) ì›”, 
		extract(day from sysdate) ì¼,
    extract(hour from localtimestamp) ì‹œ,
    extract(minute from localtimestamp) ë¶„,
    extract(second from localtimestamp) ì´ˆ,
    extract(hour from current_timestamp) íƒ€ì„ì¡´ì‹œ,
    extract(timezone_minute from current_timestamp) íƒ€ì„ì¡´ë¶„,
    extract(timezone_region from current_timestamp) íƒ€ì„ì¡´ì´ë¦„,
    extract(timezone_abbr from current_timestamp) íƒ€ì„ì¡´ì•½ì–´
FROM dual;			
```

![image.png](/assets/20250530/9.png)