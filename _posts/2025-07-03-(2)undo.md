---
title: "[50ì¼ì°¨] undo"
excerpt: "ì•„ì´í‹°ìœŒ 0703_(2) "
categories:
      - ORACLE19c
tags:
      - ORACLE19c
      - TIL
last-modified-at: 2025-07-03T23:00
---

# undo

ğŸ“ undo (9i)

- DML ì‘ì—…ì‹œ undo segments ì— ê¸°ì¡´ ê°’ì„ ì €ì¥í•œë‹¤. (ë¡¤ë°±ê³¼ ì½ê¸° ì¼ê´€ì„± ë•Œë¬¸ì—)
- íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œ (COMMIT , ROLLBACK) ë  ë•Œê¹Œì§€ëŠ” ì´ì „ ê°’ì„ ë³´ì¡´í•´ì•¼ í•œë‹¤.
- ëª©ì  :
    - rollback
    - read consistent (ì½ê¸° ì¼ê´€ì„±)
    - flashback query (10g)
    - ì‹¤íŒ¨í•œ íŠ¸ëœì­ì…˜ recovery
- undo monitoring
    - undo spaceê°€ ë¶€ì¡±í•œ ê²½ìš° ORA-01650 : unable to extend rollback segment
    - ì½ê¸° ì¼ê´€ì„±ì´ ì–´ê¸‹ë‚œ long query ì—ì„œ ORA-01555 snapshot too old
    
    ```sql
    ğŸ“ ì˜¤ì „ 9ì‹œ 10ë¶„ Long query ê¸‰ì—¬ ì •ë³´ 
    ```
    
    - enq : US - contention
    
    ```sql
    show parameter undo_tablespace
    ```
    

![image.png](/assets/20250703/11.png)

```sql
show parameter undo_retention
```

![image.png](/assets/20250703/12.png)

â–¶ï¸ ë¡± ì¿¼ë¦¬ DML ì‘ì—…ì‹œ ì´ì „ ê°’ì„ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ

```sql
select segment_id, segment_name, owner, tablespace_name, status from dba_rollback_segs;
```

![image.png](/assets/20250703/13.png)

```sql
select n.usn, n.name, s.extents, s.rssize, s.xacts, s.status
from v$rollname n , v$rollstat s
where n.usn = s.usn;

-- xacts : 
	  - 0 :  íŠ¸ëœì­ì…˜ ì•ˆí•˜ëŠ” ì¤‘
	  - 1 :  íŠ¸ëœì­ì…˜ ì‚¬ìš©ì¤‘
```

![image.png](/assets/20250703/14.png)

```sql
ğŸ“ <hr session>
update hr.employees 
set salary = salary * 1.1 
where employee_id = 200;

ğŸ“ <sys session>
-- ubafil : undo ë°ì´í„° íŒŒì¼
-- ubablk : undo ë¸”ë¡

select s.username, t.xidusn, t.ubafil, t.ubaBlk, t.used_ublk
from v$session s, v$transaction t
where s.saddr = t.ses_addr;
```

â–¶ï¸ undo_retention 

- íŠ¸ëœì­ì…˜ì´ commitì´ ë°œìƒí–ˆë”ë¼ë„ ì´ì „ ê°’ì„ undo_retention íŒŒë¼ë¯¸í„°ì— ì„¤ì •ë˜ì–´ ìˆëŠ” ì´ˆ ì‹œê°„ê¹Œì§€ ë³´ì¡´í•˜ì (ì½ê¸° ì¼ê´€ì„±)

```sql
show parameter undo_retention
```

- read consistent (ì½ê¸° ì¼ê´€ì„±)
- ì½ê¸° ì¼ê´€ì„±ì´ ì–´ê¸‹ë‚œ long queryì—ì„œ ORA-01555 snapshot too old

```sql
select tablespace_name, retention from dba_tablespaces;
```

![image.png](/assets/20250703/15.png)

â–¶ï¸ undo_retentionì„ ë³´ì¥í•´ì•¼ë  ë•Œ â†’ undo tablespaceì— ëŒ€í•œ retentionì„ guaranteeë¥¼ í•œë‹¤.

```sql
ALTER TABLESPACE undotbs1 RETENTION GUARANTEE;

SELECT tablespace_name, retention from dba_tablespaces;
```

![image.png](/assets/20250703/16.png)

â–¶ï¸ 30ë¶„ì€ ë¬´ì¡°ê±´ ë³´ì¥í•´ì•¼ í•œë‹¤.

```sql
SELECT * FROM v$parameter WHERE name IN ('undo_management', 'undo_tablespace', 'undo_retention');
```

![image.png](/assets/20250703/17.png)

â†’ ì¦‰ì‹œ ë³€ê²½í•  ìˆ˜ ìˆëŠ” íŒŒë¼ë¯¸í„°

```sql
ALTER SYSTEM SET undo_retention=1800 scope=both;

show parameter undo_retention;
```

![image.png](/assets/20250703/18.png)

â–¶ï¸ NOGUARANTEE

```sql
SELECT tablespace_name, retention from dba_tablespaces;
```

```sql
-- FLM 
CREATE UNDO TABLESPACE undo1
DATAFILE '/u01/app/oracle/oradata/ORA19C/undo1.dbf' SIZE 10M AUTOEXTEND ON;

SELECT * FROM dba_tablespaces;
```

```sql
select segment_id, segment_name, owner, tablespace_name, status from dba_rollback_segs;

-> dynamic parameter
```

```sql
alter system set undo_tablespace = undo1 scope = both;
```

![image.png](/assets/20250703/19.png)

â–¶ï¸ undo tablespace ë³€ê²½

```sql
alter system set undo_tablespace = undo1 scoppe = both;

ğŸ“ <hr session>
update hr.employees 
set salary = salary * 1.1 
where employee_id = 200;

ğŸ“ <sys session>
-- ubafil : undo ë°ì´í„° íŒŒì¼
-- ubablk : undo ë¸”ë¡

select s.username, t.xidusn, t.ubafil, t.ubaBlk, t.used_ublk
from v$session s, v$transaction t
where s.saddr = t.ses_addr;

ğŸ“ <hr session>
rollback;
```

â–¶ï¸ undo tablespaceì— ë°ì´í„° íŒŒì¼ ì¶”ê°€

```sql
-- í…Œì´ë¸” ë ˆë²¨ 
ALTER TABLESPACE undo1 ADD DATAFILE '/u01/app/oracle/oradata/ORA19C/undo2.dbf' SIZE 10m autoextend on;

select s.username, t.xidusn, t.ubafil, t.ubaBlk, t.used_ublk
from v$session s, v$transaction t
where s.saddr = t.ses_addr;

alter system set undo_tablespace = undotbs1 scope = spfile;
alter system set undo_tablespace = undotbs1 scope = both;

SELECT segment_id, segment_name, owner, tablespace_name, status FROM dba_rollback_segs;
```

â–¶ï¸ undo tablespace ì‚­ì œ

```sql
drop tablespace undo1 including contents and datafiles;
```